
<!DOCTYPE html>

<html class="no-js" lang="en">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width,initial-scale=1" name="viewport"/>
<link href="../../../assets/images/favicon.png" rel="icon"/>
<meta content="mkdocs-1.4.0, mkdocs-material-8.5.6" name="generator"/>
<title>Restricted Boltzmann Machine - Daring and Persistent | Hao Ma, Ph.D.</title>
<link href="../../../assets/stylesheets/main.20d9efc8.min.css" rel="stylesheet"/>
<link href="../../../assets/stylesheets/palette.cbb835fc.min.css" rel="stylesheet"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css?family=Gaegu:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&amp;display=fallback" rel="stylesheet"/>
<style>:root{--md-text-font:"Gaegu";--md-code-font:"Roboto Mono"}</style>
<link href="../../../stylesheets/extra.css" rel="stylesheet"/>
<script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
</head>
<body data-md-color-accent="" data-md-color-primary="" data-md-color-scheme="light-scheme" dir="ltr">
<script>var palette=__md_get("__palette");if(palette&&"object"==typeof palette.color)for(var key of Object.keys(palette.color))document.body.setAttribute("data-md-color-"+key,palette.color[key])</script>
<input autocomplete="off" class="md-toggle" data-md-toggle="drawer" id="__drawer" type="checkbox"/>
<input autocomplete="off" class="md-toggle" data-md-toggle="search" id="__search" type="checkbox"/>
<label class="md-overlay" for="__drawer"></label>
<div data-md-component="skip">
<a class="md-skip" href="#markov-chain-monte-carlo-simulations-for-the-ising-model">
          Skip to content
        </a>
</div>
<div data-md-component="announce">
<aside class="md-banner">
<div class="md-banner__inner md-grid md-typeset">
<button aria-label="Don't show this again" class="md-banner__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
            
            

   Always to do what you are afraid to do.
   <style>
      .md-banner__inner{
         font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
         text-align: center;
         font-weight: bold;
         font-size: 1rem;
      }

      aside.md-banner{
         background-image: linear-gradient(to right, rgba(137, 181, 221, 0.959),rgba(5, 121, 230, 0.959));

      }
   </style>
</div>
<script>var content,el=document.querySelector("[data-md-component=announce]");el&&(content=el.querySelector(".md-typeset"),__md_hash(content.innerHTML)===__md_get("__announce")&&(el.hidden=!0))</script>
</aside>
</div>
<header class="md-header md-header--lifted" data-md-component="header">
<nav aria-label="Header" class="md-header__inner md-grid">
<a aria-label="Daring and Persistent | Hao Ma, Ph.D." class="md-header__button md-logo" data-md-component="logo" href="../../.." title="Daring and Persistent | Hao Ma, Ph.D.">
<img alt="logo" src="../../../assets/logo.jpeg"/>
</a>
<label class="md-header__button md-icon" for="__drawer">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"></path></svg>
</label>
<div class="md-header__title" data-md-component="header-title">
<div class="md-header__ellipsis">
<div class="md-header__topic">
<span class="md-ellipsis">
            Daring and Persistent | Hao Ma, Ph.D.
          </span>
</div>
<div class="md-header__topic" data-md-component="header-topic">
<span class="md-ellipsis">
            
              Restricted Boltzmann Machine
            
          </span>
</div>
</div>
</div>
<form class="md-header__option" data-md-component="palette">
<input aria-label="Switch to dark mode" class="md-option" data-md-color-accent="" data-md-color-media="(prefers-color-scheme: light)" data-md-color-primary="" data-md-color-scheme="light-scheme" id="__palette_1" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_2" hidden="" title="Switch to dark mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3 3.19.09m3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95 2.06.05m-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31Z"></path></svg>
</label>
<input aria-label="Switch to light mode" class="md-option" data-md-color-accent="" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-primary="" data-md-color-scheme="slate" id="__palette_2" name="__palette" type="radio"/>
<label class="md-header__button md-icon" for="__palette_1" hidden="" title="Switch to light mode">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5c-.84 0-1.65.15-2.39.42L12 2M3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29L3.34 7m.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14L3.36 17M20.65 7l-1.77 3.79a7.023 7.023 0 0 0-2.38-4.15l4.15.36m-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29L20.64 17M12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44L12 22Z"></path></svg>
</label>
</form>
<label class="md-header__button md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
</label>
<div class="md-search" data-md-component="search" role="dialog">
<label class="md-search__overlay" for="__search"></label>
<div class="md-search__inner" role="search">
<form class="md-search__form" name="search">
<input aria-label="Search" autocapitalize="off" autocomplete="off" autocorrect="off" class="md-search__input" data-md-component="search-query" name="query" placeholder="Search" required="" spellcheck="false" type="text"/>
<label class="md-search__icon md-icon" for="__search">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"></path></svg>
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</label>
<nav aria-label="Search" class="md-search__options">
<button aria-label="Clear" class="md-search__icon md-icon" tabindex="-1" title="Clear" type="reset">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"></path></svg>
</button>
</nav>
</form>
<div class="md-search__output">
<div class="md-search__scrollwrap" data-md-scrollfix="">
<div class="md-search-result" data-md-component="search-result">
<div class="md-search-result__meta">
            Initializing search
          </div>
<ol class="md-search-result__list"></ol>
</div>
</div>
</div>
</div>
</div>
</nav>
<nav aria-label="Tabs" class="md-tabs" data-md-component="tabs">
<div class="md-tabs__inner md-grid">
<ul class="md-tabs__list">
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../..">
      Home
    </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link md-tabs__link--active" href="../../">
        Learning
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../teaching/">
        Teaching
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../life/">
        Life
      </a>
</li>
<li class="md-tabs__item">
<a class="md-tabs__link" href="../../../tags/">
      Tags
    </a>
</li>
</ul>
</div>
</nav>
</header>
<div class="md-container" data-md-component="container">
<main class="md-main" data-md-component="main">
<div class="md-main__inner md-grid">
<div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Navigation" class="md-nav md-nav--primary md-nav--lifted" data-md-level="0">
<label class="md-nav__title" for="__drawer">
<a aria-label="Daring and Persistent | Hao Ma, Ph.D." class="md-nav__button md-logo" data-md-component="logo" href="../../.." title="Daring and Persistent | Hao Ma, Ph.D.">
<img alt="logo" src="../../../assets/logo.jpeg"/>
</a>
    Daring and Persistent | Hao Ma, Ph.D.
  </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../..">
        Home
      </a>
</li>
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_2" id="__nav_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../">Learning</a>
<label for="__nav_2">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Learning" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_2">
<span class="md-nav__icon md-icon"></span>
          Learning
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle" data-md-toggle="__nav_2_2" id="__nav_2_2" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../">Machine Learning</a>
<label for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Machine Learning" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_2">
<span class="md-nav__icon md-icon"></span>
          Machine Learning
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item md-nav__item--active">
<input class="md-nav__toggle md-toggle" data-md-toggle="toc" id="__toc" type="checkbox"/>
<label class="md-nav__link md-nav__link--active" for="__toc">
          Restricted Boltzmann Machine
          <span class="md-nav__icon md-icon"></span>
</label>
<a class="md-nav__link md-nav__link--active" href="./">
        Restricted Boltzmann Machine
      </a>
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#markov-chain-monte-carlo-simulations-for-the-ising-model">
    Markov Chain Monte Carlo simulations for the Ising Model
  </a>
<nav aria-label="Markov Chain Monte Carlo simulations for the Ising Model" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ising-model">
    Ising Model
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#markov-chain-monte-carlo-simulations">
    Markov Chain Monte Carlo Simulations
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restricted-boltzmann-machine">
    Restricted Boltzmann Machine
  </a>
<nav aria-label="Restricted Boltzmann Machine" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#training">
    Training
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rbm-training-algorithm">
    RBM Training Algorithm
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#implementation-in-python">
    Implementation in Python
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#binary-conditional-rbm">
    Binary Conditional RBM
  </a>
<nav aria-label="Binary Conditional RBM" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#implementation-in-python_1">
    Implementation in Python
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../transformer/">
        Head First Transformer
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_2_3" id="__nav_2_3" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../web-and-cloud/">Web and Cloud</a>
<label for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Web and Cloud" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_3">
<span class="md-nav__icon md-icon"></span>
          Web and Cloud
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../web-and-cloud/vuejs/">
        Vue.js
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_2_4" id="__nav_2_4" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../networks/">Networks</a>
</div>
<nav aria-label="Networks" class="md-nav" data-md-level="2">
<label class="md-nav__title" for="__nav_2_4">
<span class="md-nav__icon md-icon"></span>
          Networks
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_3" id="__nav_3" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../teaching/">Teaching</a>
<label for="__nav_3">
<span class="md-nav__icon md-icon"></span>
</label>
</div>
<nav aria-label="Teaching" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_3">
<span class="md-nav__icon md-icon"></span>
          Teaching
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="../../../teaching/teaching-philosophy/">
        Teaching Philosophy
      </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../teaching/kpu/">
        CSIT@KPU
      </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item md-nav__item--nested">
<input checked="" class="md-nav__toggle md-toggle md-toggle--indeterminate" data-md-toggle="__nav_4" id="__nav_4" type="checkbox"/>
<div class="md-nav__link md-nav__link--index">
<a href="../../../life/">Life</a>
</div>
<nav aria-label="Life" class="md-nav" data-md-level="1">
<label class="md-nav__title" for="__nav_4">
<span class="md-nav__icon md-icon"></span>
          Life
        </label>
<ul class="md-nav__list" data-md-scrollfix="">
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="../../../tags/">
        Tags
      </a>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc">
<div class="md-sidebar__scrollwrap">
<div class="md-sidebar__inner">
<nav aria-label="Table of contents" class="md-nav md-nav--secondary">
<label class="md-nav__title" for="__toc">
<span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
<ul class="md-nav__list" data-md-component="toc" data-md-scrollfix="">
<li class="md-nav__item">
<a class="md-nav__link" href="#markov-chain-monte-carlo-simulations-for-the-ising-model">
    Markov Chain Monte Carlo simulations for the Ising Model
  </a>
<nav aria-label="Markov Chain Monte Carlo simulations for the Ising Model" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#ising-model">
    Ising Model
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#markov-chain-monte-carlo-simulations">
    Markov Chain Monte Carlo Simulations
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#restricted-boltzmann-machine">
    Restricted Boltzmann Machine
  </a>
<nav aria-label="Restricted Boltzmann Machine" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#training">
    Training
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#rbm-training-algorithm">
    RBM Training Algorithm
  </a>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#implementation-in-python">
    Implementation in Python
  </a>
</li>
</ul>
</nav>
</li>
<li class="md-nav__item">
<a class="md-nav__link" href="#binary-conditional-rbm">
    Binary Conditional RBM
  </a>
<nav aria-label="Binary Conditional RBM" class="md-nav">
<ul class="md-nav__list">
<li class="md-nav__item">
<a class="md-nav__link" href="#implementation-in-python_1">
    Implementation in Python
  </a>
</li>
</ul>
</nav>
</li>
</ul>
</nav>
</div>
</div>
</div>
<div class="md-content" data-md-component="content">
<article class="md-content__inner md-typeset">
<nav class="md-tags">
<a class="md-tag" href="../../../tags/#machine-learning">machine learning</a>
<a class="md-tag" href="../../../tags/#generative-model">generative model</a>
<a class="md-tag" href="../../../tags/#markov-chain-monte-carlo">Markov Chain Monte Carlo</a>
<a class="md-tag" href="../../../tags/#restricted-boltzmann-machine">Restricted Boltzmann Machine</a>
<a class="md-tag" href="../../../tags/#gibbs-sampling">Gibbs Sampling</a>
<a class="md-tag" href="../../../tags/#energy-model">Energy Model</a>
<a class="md-tag" href="../../../tags/#markov-random-field">Markov Random Field</a>
</nav>
<h1><span class="enumerate-headings-plugin enumerate-heading-plugin">1.</span> Restricted Boltzmann Machine</h1>
<p>An introduction to Restricted Boltzmann Machine and Conditional Restricted Boltzmann Machine.</p>
<h2 id="markov-chain-monte-carlo-simulations-for-the-ising-model"><span class="enumerate-headings-plugin enumerate-heading-plugin">1.1</span> Markov Chain Monte Carlo simulations for the Ising Model</h2>
<h3 id="ising-model"><span class="enumerate-headings-plugin enumerate-heading-plugin">1.1.1</span> Ising Model</h3>
<p>The Ising model is a formalized stochastic model of ferromagnet (i.e., an ordinary magnet) and is a <span class="arithmatex">\(d\)</span>-dimensional lattice that can be denoted as the set below:</p>
<div class="arithmatex">\[ I = \Big\{(x_1,x_2,\ldots,x_d)\in\mathbb{Z}^d: 1\leq x_l\leq L, l=1,2,\ldots,d\Big\}.\]</div>
<p>Each site can be considered as an iron atom if <span class="arithmatex">\(I\)</span> is an iron magnet. Specifically, a 2-dimensional Ising model contains <span class="arithmatex">\(L^2\)</span> sites which are evenly distributed in a square lattice. </p>
<p>A <em>spin configuration</em> on <span class="arithmatex">\(I\)</span> is a function:</p>
<div class="arithmatex">\[ \mathbf{\sigma}: I\xrightarrow{} \Big\{\pm 1\Big\} \]</div>
<p>which assigns a spin up (+1) or a spin down (-1) to each site in <span class="arithmatex">\(I\)</span>.</p>
<p><em>Hamiltonian</em> <span class="arithmatex">\(\mathcal{H}(\mathbf{\sigma})\)</span> is a function which specifies the total energy of a spin configuration. In the absence of an external magnetic field, it is defined as </p>
<div class="arithmatex">\[ \mathcal{H}(\mathbf{\sigma}) = - J \sum_{x,y}\sigma_x\sigma_y \]</div>
<p>where <span class="arithmatex">\(J\)</span> is the <em>coupling constant </em>, and <span class="arithmatex">\(\sigma_x\)</span> and <span class="arithmatex">\(\sigma_y\)</span> represent the spin of site <span class="arithmatex">\(x\)</span> and site <span class="arithmatex">\(y\)</span>, respectively, and the summation is taken over all pairs of <span class="arithmatex">\((x,y)\)</span> where site <span class="arithmatex">\(x\)</span> and <span class="arithmatex">\(y\)</span> are neighbours. Two sites are neighbours if exactly one coordinate of two sites differ by 1.</p>
<p>The probability of a spin configuration follows the <em>Boltzmann distribution</em>:</p>
<div class="arithmatex">\[ p(\mathbf{\sigma})=\frac{1}{Z}\exp(-\frac{\mathcal{H}(\mathbf{\sigma})}{k_B T})\]</div>
<p>where <span class="arithmatex">\(k_B\)</span> is the Boltzmann constant and <span class="arithmatex">\(T\)</span> is the absolute temperature. <span class="arithmatex">\(Z\)</span> is a normalizing constant known as the <em>partition function</em> and is defined as </p>
<div class="arithmatex">\[ Z = \sum_{\sigma}\exp(-\frac{\mathcal{H}(\mathbf{\sigma})}{k_B T}) \]</div>
<h3 id="markov-chain-monte-carlo-simulations"><span class="enumerate-headings-plugin enumerate-heading-plugin">1.1.2</span> Markov Chain Monte Carlo Simulations</h3>
<p>The number of configuration in the Ising model is exponential of the number of sites, which makes the calculation of the normalizing constant <span class="arithmatex">\(Z\)</span> intractable for a large <span class="arithmatex">\(L\)</span>. Therefore, we often study the Ising model using Monte Carlo simulations. If we could sample <span class="arithmatex">\(N\)</span> spin configurations from the Boltzmann distribution, then the expectation value of an observable <span class="arithmatex">\(\mathcal{O}\)</span> can be approximated by</p>
<div class="arithmatex">\[ \mathbb{E}(\mathcal{O})=\frac{1}{N}\sum_{i}^N\mathcal{O}(\sigma^i) \]</div>
<p>where <span class="arithmatex">\(\sigma^i\)</span> is the <span class="arithmatex">\(i_{\mathrm{th}}\)</span> spin configuration sample. </p>
<p>In spite of the computational intractability to compute the partition function <span class="arithmatex">\(Z\)</span>, we can still sample the Boltzmann distribution using Markov Chain Monte Carlo (MCMC) techniques, specifically, <em>Metropolis Algorithm</em>, which is a special case of the <em>Metropolis-Hasting Algorithm</em>. For this specific problem, the algorithm goes like below:</p>
<div class="admonition note">
<p class="admonition-title">Metropolis Algorithm for Boltzmann Distribution</p>
<ol>
<li>Initialize <span class="arithmatex">\(\sigma^0\)</span>. A common practice is to independently and randomly assign +1 or -1 to each site.</li>
<li>Randomly choose a site <span class="arithmatex">\(x\)</span>.</li>
<li>Let <span class="arithmatex">\(\sigma^\prime\)</span> be the spin configuration obtained by the flipping the spin at <span class="arithmatex">\(x\)</span> of the current spin configuration <span class="arithmatex">\(\sigma\)</span> , i.e., <span class="arithmatex">\(\sigma_x^\prime=-\sigma_x\)</span> and <span class="arithmatex">\(\sigma_y^\prime=-\sigma_y\)</span> for all <span class="arithmatex">\(y\neq x\)</span>.</li>
<li>Let <span class="arithmatex">\(U_n\)</span> be a standard uniform random variable. </li>
<li>If <span class="arithmatex">\(U_n\leq \frac{p(\sigma^\prime)}{p(\sigma)}=\exp\Big(-\frac{\mathcal{H}(\sigma^\prime)-\mathcal{H}(\sigma)}{k_B T}\Big)\)</span>, then accept the spin flip and set <span class="arithmatex">\(\sigma^{n+1}=\sigma^\prime\)</span>. Otherwise, reject the spin flip and set <span class="arithmatex">\(\sigma^{n+1}=\sigma^n\)</span>.</li>
<li><span class="arithmatex">\(n = n+1\)</span> and return to Step 2. </li>
</ol>
</div>
<p>After we obtain a sequence of spin configurations, we will sub-sample those configurations every <span class="arithmatex">\(\tau\)</span> steps to make sure that the samples are i.i.d samples. The result of the sub-sampling will be a sequence of spin configurations that contain </p>
<div class="arithmatex">\[ \sigma^T, \sigma^{T+\tau}, \sigma^{T+2\tau},\ldots \]</div>
<p>where <span class="arithmatex">\(T\)</span> and <span class="arithmatex">\(\tau\)</span> are known as the <em>burn-in period</em> and the <em>sampling period</em>.</p>
<h2 id="restricted-boltzmann-machine"><span class="enumerate-headings-plugin enumerate-heading-plugin">1.2</span> Restricted Boltzmann Machine</h2>
<p>A Restricted Boltzmann Machine (RBM) is a bipartite graph. The structure of a RBM that contains 3 hidden nodes and 3 visible nodes is illustrated below. </p>
<div class="rbm">
<img alt="a terrible drawing a rbm structure" src="../../../assets/RBM.PNG" title="a terrible drawing of a RBM structure"/>
</div>
<p>In the following, we consider a RBM that contains <span class="arithmatex">\(V\)</span> visible nodes and <span class="arithmatex">\(H\)</span> hidden nodes, where every visible node is connected with every hidden node, with no connection among each layer. In this tutorial, we focus on Bernoulli RBM where the value of each node is either 0 or 1. </p>
<p>RBM is a theoretical model inspired by statistical mechanics. In this model, the value of <span class="arithmatex">\(\mathbf{v}=[v_1, v_2, \ldots, v_V]\)</span> and <span class="arithmatex">\(\mathbf{h}=[h_1, h_2, \ldots, h_H]\)</span>  satisfy Boltzmann (Gibbs) distribution, which claims that the probability of a system staying in a certain micro-state is the function of the system energy and the system temperature. For the RBM model, the probability distribution of <span class="arithmatex">\(\mathbf{v}\)</span> and <span class="arithmatex">\(\mathbf{h}\)</span> can be expressed as:</p>
<div class="arithmatex">\[ p_{\theta}(\mathbf{v},\mathbf{h}) = \frac{1}{Z}\mathrm{exp}(-E(\mathbf{v},\mathbf{h})) \]</div>
<p>where <span class="arithmatex">\(\theta=\{\mathbf{W},\mathbf{b},\mathbf{c}\}\)</span>, and the normalization constant <span class="arithmatex">\(Z=\sum_{\mathbf{v},\mathbf{h}}\mathrm{exp}(-E(\mathbf{v},\mathbf{h}))\)</span> is referred to as the <em>partition function</em>, and <span class="arithmatex">\(E(\mathbf{v},\mathbf{h})\)</span> is the energy function calculated by </p>
<div class="arithmatex">\[ E(\mathbf{v},\mathbf{h}) = -\mathbf{h}^T\mathbf{W}\mathbf{v}-\mathbf{b}^T\mathbf{v}-\mathbf{c}^T\mathbf{h}
=-\sum_{j}\sum_k h_j W_{j,k} v_k - \sum_k b_kv_k - \sum_j c_j h_j
\]</div>
<p>where <span class="arithmatex">\(\mathbf{c}\)</span> and <span class="arithmatex">\(\mathbf{b}\)</span> are the visible and hidden bias terms, respectively. Note here that <span class="arithmatex">\(Z\)</span> is intractable to compute for a large RBM model. </p>
<h3 id="training"><span class="enumerate-headings-plugin enumerate-heading-plugin">1.2.1</span> Training</h3>
<p>The first question that we need to ask is what the objective function is. We can look at this from two perspectives:</p>
<ul>
<li>Kullback-Leibler (K-L) Divergence </li>
<li>Maximum Likelihood</li>
</ul>
<p>K-L divergence is a measurement of distance between two probability distributions. In RBM, we would like to minimize the K-L divergence between the unknown distribution of the training data <span class="arithmatex">\(p_\mathbf{train}(\mathbf{v})\)</span> and the distribution represented by the RBM <span class="arithmatex">\(p_{\theta}(\mathbf{v})\)</span>:</p>
<div class="arithmatex">\[ 
\begin{eqnarray}
&amp;\textrm{KL}(p_\mathbf{train}\|p_\mathbf{\theta})&amp;=\sum_{\mathbf{v}} \Big(p_\mathbf{train}(\mathbf{v})\log\frac{p_\mathbf{train}(\mathbf{v})}{p_\theta(\mathbf{v})}\Big) \nonumber \\
&amp;&amp;= \sum_{\mathbf{v}}p_\mathbf{train}(\mathbf{v})\log p_\mathbf{train}(\mathbf{v})-\sum_{\mathbf{v}}p_\mathbf{train}(\mathbf{v})\log p_\theta(\mathbf{v}) \nonumber \\
\end{eqnarray}
\]</div>
<p>So </p>
<div class="arithmatex">\[
\begin{eqnarray}
&amp;\underset{\theta}{\min}~ \textrm{KL} &amp;\Longleftrightarrow  \underset{\theta}{\max}\sum_{\mathbf{v}}p_\mathbf{train}(\mathbf{v})\log p_\theta(\mathbf{v}) \\
&amp;&amp;\nonumber \Longleftrightarrow \underset{\theta}{\max}\frac{1}{N}\sum_{\hat{\mathbf{v}_i}}\log p_\theta(\mathbf{\hat{v}_i})  ~\textrm{,}~ \hat{\mathbf{v}_i} ~\text{is a sample from}~ p_\mathbf{train}(\mathbf{\hat{v}})\\
&amp;&amp; \Longleftrightarrow\underset{\theta}{\max}\prod_{\hat{\mathbf{v}_i}}p_\theta(\hat{\mathbf{v}_i})
\end{eqnarray}
\]</div>
<p>So the minimization of the KL divergence is equivalent to the Maximum Likelihood. </p>
<div class="arithmatex">\[
\begin{eqnarray}
&amp;p_\theta(\mathbf{v})&amp;=\sum_{\mathbf{h}}p_{\theta}(\mathbf{v},\mathbf{h})\\
&amp;\nonumber &amp;=\sum_{\mathbf{h}}\frac{1}{Z}\exp(-E(\mathbf{v},\mathbf{h}))\\
&amp;\nonumber &amp;=\frac{1}{Z}\sum_{\mathbf{h}}\exp(\mathbf{h}^T\mathbf{W}\mathbf{v}+\mathbf{b}^T\mathbf{v}+\mathbf{c}^T\mathbf{h})\\
&amp;\nonumber &amp;=\frac{1}{Z}\exp(\mathbf{b}^T\mathbf{v})\sum_{\mathbf{h}}\exp(\mathbf{h}^T\mathbf{W}\mathbf{v}+\mathbf{c}^T\mathbf{h})\\
&amp;\nonumber &amp;=\frac{1}{Z}\exp(\mathbf{b}^T\mathbf{v})\sum_{\mathbf{h}}\exp(\sum_{j=1}^{H}(h_jW_{j,:}\mathbf{v}+c_jh_j))\\
&amp;\nonumber &amp;=\frac{1}{Z}\exp(\mathbf{b}^T\mathbf{v})\sum_{h_1\in\{0,1\}}\exp(h_1W_{1,:}\mathbf{v}+c_1h_1) ~\ldots~\sum_{h_H\in\{0,1\}} \exp(h_H W_{H,:}\mathbf{v}+c_H h_H)\\
&amp;\nonumber &amp;=\frac{1}{Z}\exp(\mathbf{b}^T\mathbf{v})\prod_j(1+\exp(W_{j,:}\mathbf{v}+c_j))\\
&amp;\nonumber &amp;=\frac{1}{Z}\exp(-F(\mathbf{v}))
\end{eqnarray}
\]</div>
<p>where <span class="arithmatex">\(F(\mathbf{v})\)</span> is the <em>free energy</em> and can be calculated by</p>
<div class="arithmatex">\[ F(\mathbf{v})=-\mathbf{b}^T\mathbf{v}-\sum_{j=1}^{H}\log (1+\exp(W_{j,:}\mathbf{v}+c_j)) \]</div>
<p>Define <span class="arithmatex">\(\theta=\{\mathbf{W},\mathbf{b},\mathbf{c}\}\)</span>, we will have</p>
<div class="arithmatex">\[
\begin{eqnarray}
 &amp; -\frac{\partial \log p_{\mathbf{\theta}}(\mathbf{v})}{\partial \mathbf{\theta}}&amp;=-\frac{\partial }{\partial \theta}\Big(\log\frac{\exp(-F(\mathbf{v}))}{Z}\Big)\\
&amp; &amp;=\frac{\partial }{\partial \theta}(F(\mathbf{v})+\log Z)\\
&amp;&amp;=\frac{\partial F(\mathbf{v}) }{\partial \theta}+\frac{1}{Z}\frac{\partial Z}{\partial \theta}\\
&amp; &amp;=\frac{\partial F(\mathbf{v}) }{\partial \theta}+\sum_{\mathbf{v^\prime}}\frac{1}{Z}\exp(-F(\mathbf{v}^\prime))\frac{\partial (-F(\mathbf{v}^\prime))}{\partial \theta}\\
&amp; &amp;=\frac{\partial F(\mathbf{v}) }{\partial \theta}-\sum_{\mathbf{v^\prime}}p_{\theta}(\mathbf{v}^\prime)\frac{\partial F(\mathbf{v}^\prime)}{\partial \theta}\\
&amp;&amp;=\frac{\partial F(\mathbf{v})}{\partial \theta}-\mathbb{E}_{\mathbf{v}^\prime}\Big[\frac{\partial F(\mathbf{v}^\prime)}{\partial \theta}\Big] \tag{1}\label{eq1}
\end{eqnarray}
\]</div>
<p>with <span class="arithmatex">\(\mathbf{v}^\prime \sim p_{\theta}(\mathbf{v}^\prime)\)</span>. while $ \frac{\partial F(\mathbf{v})}{\partial \theta}$ can be expressed as</p>
<div class="arithmatex">\[\begin{eqnarray}    
\nonumber &amp;\frac{\partial F(\mathbf{v})}{\partial w_{j,k}} = -p_\theta(h_j=1|\mathbf{v})v_k\\
\nonumber &amp;\frac{\partial F(\mathbf{v})}{\partial \mathbf{b}} = -\mathbf{v}\\
\nonumber &amp;\frac{\partial F(\mathbf{v})}{\partial \mathbf{c}} = -p_\theta(h_j=1|\mathbf{v})
\end{eqnarray}\]</div>
<p>The second term in Eq.~<span class="arithmatex">\(\eqref{eq1}\)</span> requires an exponential computational complexity, so we will use samples drawn from the <span class="arithmatex">\(p_{\theta}(\mathbf{v}^\prime)\)</span> to approximate the expectation based on MCMC techniques. However, we could apply block Gibbs Sampling, which is actually a special case of <em>Metropolis-Hastings algorithm</em>, to obtain samples if <span class="arithmatex">\(p(\mathbf{v}| \mathbf{h})\)</span> and <span class="arithmatex">\(p(\mathbf{h}| \mathbf{v})\)</span> are available:</p>
<div class="admonition note">
<p class="admonition-title">Gibbs sampling</p>
<ol>
<li>Initialization: <span class="arithmatex">\(\mathbf{v}^1\)</span></li>
<li>Find: <span class="arithmatex">\(p(\mathbf{h}^1| \mathbf{v}^1)\)</span></li>
<li>Sample <span class="arithmatex">\(\mathbf{h}^1\sim p(\mathbf{h}^1| \mathbf{v}^1)\)</span></li>
<li>Find: <span class="arithmatex">\(p(\mathbf{v}^2| \mathbf{h}^2)\)</span></li>
<li>Sample: <span class="arithmatex">\(\mathbf{v}^2 \sim p(\mathbf{v}^2| \mathbf{h}^2)\)</span> </li>
</ol>
<p><div class="highlight"><pre><span></span><code><a href="#__codelineno-0-1" id="__codelineno-0-1" name="__codelineno-0-1"></a>... 
</code></pre></div>
6. Until equilibrium.  </p>
</div>
<p>After sampling <span class="arithmatex">\(N\)</span> samples of <span class="arithmatex">\(\mathbf{v}^\prime\)</span>, i.e., <span class="arithmatex">\(\{\mathbf{v}_k^\prime\}|_{k=1,2,\ldots,N}\)</span>, we can use the sample mean to approximate the expectation:</p>
<div class="arithmatex">\[\begin{eqnarray}
\mathbb{E}_{\mathbf{v}^\prime}\Big[\frac{\partial F(\mathbf{v}^\prime)}{\partial \theta}\Big]\approx \frac{1}{N}\sum_{k}\frac{\partial F(\mathbf{v}_k^\prime)}{\partial \theta}
\end{eqnarray}\]</div>
<p>However, this process, which requires us to wait until the Markov chain reaches equilibrium, is computationally inefficient. To resolve this, we use Contrastive Divergence (CD) to approximate the true value with a point estimate. CD-<span class="arithmatex">\(n\)</span> indicates that the point estimate <span class="arithmatex">\(\frac{\partial F(\mathbf{v}^n)}{\partial \theta}\)</span> can be used to approximate <span class="arithmatex">\(\mathbb{E}_{\mathbf{v}^\prime}\Big[\frac{\partial F(\mathbf{v}^\prime)}{\partial \theta}\Big]\)</span>, given the initialization is the training data point. </p>
<div class="arithmatex">\[\begin{eqnarray}
    \mathbb{E}_{\mathbf{v}^\prime}\Big[\frac{\partial F(\mathbf{v}^\prime)}{\partial \theta}\Big]\approx\frac{\partial F(\mathbf{v}^n)}{\partial \theta}
\end{eqnarray}\]</div>
<p>So Eq.<span class="arithmatex">\(\eqref{eq1}\)</span> can be approximated as</p>
<div class="arithmatex">\[\begin{eqnarray}
 \nonumber -\frac{\partial \log p_{\mathbf{\theta}}(\mathbf{v})}{\partial \mathbf{\theta}}&amp;=\frac{\partial F(\mathbf{v})}{\partial \theta}-\mathbb{E}_{\mathbf{v}^\prime}\Big[\frac{\partial F(\mathbf{v}^\prime)}{\partial \theta}\Big]\\
 &amp;\approx\frac{\partial F(\mathbf{v})}{\partial \theta}-\frac{\partial F(\mathbf{v}^n)}{\partial \theta}
\end{eqnarray}\]</div>
<p>So </p>
<div class="arithmatex">\[\begin{eqnarray}
    &amp;-\frac{\partial \log p_{\mathbf{\theta}}(\mathbf{v})}{\partial w_{j,k}}=
-p_\theta(h_j=1|\mathbf{v})v_k+p_\theta(h_j=1|\mathbf{v}^n)v_k^n \tag{2}\label{eq:g1}\\
&amp;-\frac{\partial \log p_{\mathbf{\theta}}(\mathbf{v})}{\partial \mathbf{b}} = -\mathbf{v}+\mathbf{v}^n\tag{3}\label{eq:g2}\\
&amp;-\frac{\partial \log p_{\mathbf{\theta}}(\mathbf{v})}{\partial \mathbf{c}} = -p_\theta(h_j=1|\mathbf{v})+p_\theta(h_j=1|\mathbf{v}^n)\tag{4}\label{eq:g3}
\end{eqnarray}\]</div>
<p>Now let's talk about how to calculate <span class="arithmatex">\(p_{\theta}(\mathbf{h}|\mathbf{v})\)</span> and <span class="arithmatex">\(p(\mathbf{v}|\mathbf{h})\label{eq:q3}\)</span>.</p>
<div class="admonition note">
<p class="admonition-title">Detailed Derivation</p>
<div class="arithmatex">\[
\begin{eqnarray}
&amp;\nonumber p_\theta(\mathbf{h}|\mathbf{v})&amp;=\frac{p_\theta(\mathbf{v},\mathbf{h}) }{p_\theta(\mathbf{v}) }\\
\nonumber &amp;&amp;=\frac{\exp(-E(\mathbf{v},\mathbf{h}))}{\sum_{\mathbf{h}}\exp(-E(\mathbf{v},\mathbf{h}))}\\
&amp;\nonumber &amp;=\frac{\exp(\mathbf{h}^T\mathbf{W}\mathbf{v}+\mathbf{c}^T\mathbf{h})}{\sum_{\mathbf{h}}\exp(\mathbf{h}^T\mathbf{W}\mathbf{v}+\mathbf{c}^T\mathbf{h})}\\
&amp;\nonumber &amp;=\frac{\exp(\sum_j(h_j W_{j,:}\mathbf{v}+c_jh_j))}{\sum_{h_1}\ldots\sum_{h_H}\exp(\sum_j(h_j W_{j,:}\mathbf{v}+c_jh_j))}\\
&amp;\nonumber &amp;=\frac{\prod_j\exp(h_j W_{j,:}\mathbf{v}+c_jh_j)}{(\sum_{h_1}\exp(h_1 W_{1,:}\mathbf{v}+c_1h_1))(\sum_{h_2}\exp(h_2 W_{2,:}\mathbf{v}+c_2h_2))\ldots(\sum_{h_H}\exp(h_H W_{H,:}\mathbf{v}+c_H h_H)}\\
&amp;\nonumber &amp;=\prod_j\frac{\exp(h_j W_{j,:}\mathbf{v}+c_jh_j)}{1+\exp(W_{j,:}\mathbf{v}+c_j)}\\
&amp;&amp;=\prod_j p_\theta (h_j|\mathbf{v})
\end{eqnarray}\]</div>
</div>
<p>So <span class="arithmatex">\(h_1\)</span>, <span class="arithmatex">\(h_2\)</span>, <span class="arithmatex">\(\ldots\)</span>, <span class="arithmatex">\(h_H\)</span> are conditionally independent given <span class="arithmatex">\(\mathbf{v}\)</span>, with</p>
<div class="arithmatex">\[\begin{eqnarray}
    p_\theta(h_j|\mathbf{v})=\frac{\exp(h_j W_{j,:}\mathbf{v}+c_jh_j)}{1+\exp(W_{j,:}\mathbf{v}+c_j)}
\end{eqnarray}\]</div>
<p>Specifically, </p>
<div class="arithmatex">\[
\begin{eqnarray}
    \nonumber p_\theta(h_j=1|\mathbf{v})=\frac{\exp( W_{j,:}\mathbf{v}+c_j)}{1+\exp(W_{j,:}\mathbf{v}+c_j)}\\
    \nonumber p_\theta(h_j=0|\mathbf{v})=\frac{1}{1+\exp(W_{j,:}\mathbf{v}+c_j)}
\end{eqnarray}
\]</div>
<p>Similarly, we can derive that </p>
<div class="arithmatex">\[
\begin{eqnarray}
    p_\theta(v_k|\mathbf{h})=\frac{\exp(\mathbf{h}^T W_{:,k}v_{k}+b_kv_k)}{1+\exp(\mathbf{h}^T W_{:,k}+b_k)}
\end{eqnarray}
\]</div>
<p>Specifically, </p>
<div class="arithmatex">\[
\begin{eqnarray}
    \nonumber p_\theta(v_k=1|\mathbf{h})=\frac{\exp(\mathbf{h}^T W_{:,k}+b_k)}{1+\exp(\mathbf{h}^T W_{:,k}+b_k)}\\
    \nonumber p_\theta(v_k=0|\mathbf{h})=\frac{1}{1+\exp(\mathbf{h}^T W_{:,k}+b_k)}
\end{eqnarray}
\]</div>
<p>Alternatively, the derivation in some tutorials or papers does not involve the free energy function <span class="arithmatex">\(F(\mathbf{v})\)</span>. In that case, <span class="arithmatex">\(p_{\theta}(\mathbf{v})\)</span> can be expressed as</p>
<div class="arithmatex">\[
\begin{eqnarray}
    \nonumber p_\theta(\mathbf{v})&amp;=\sum_{\mathbf{h}}p_\theta(\mathbf{v},\mathbf{h})\\
    &amp;=\sum_{\mathbf{h}}\frac{1}{Z}\mathrm{exp}(-E(\mathbf{v},\mathbf{h}))
\end{eqnarray}
\]</div>
<p>So </p>
<div class="admonition note">
<p class="admonition-title">Detailed Derivation</p>
<div class="arithmatex">\[
\begin{eqnarray}
    &amp;\nonumber &amp;-\frac{\partial \log p_{\mathbf{\theta}}(\mathbf{v})}{\partial \mathbf{\theta}}=-\frac{\partial}{\partial \theta}\Big(\log\sum_{\mathbf{h}}\exp(-E(\mathbf{v},\mathbf{h}))\Big)+\frac{\partial}{\partial \theta}\Big(\log\sum_{\mathbf{v},\mathbf{h}}\exp(-E(\mathbf{v},\mathbf{h}))\Big)\\
    &amp;\nonumber &amp;=\frac{1}{\sum_{\mathbf{h}}\exp(-E(\mathbf{v},\mathbf{h}))}\sum_{\mathbf{h}}\exp(-E(\mathbf{v},\mathbf{h}))\frac{\partial E(\mathbf{v},\mathbf{h})}{\partial \theta}-\frac{1}{\sum_{\mathbf{v},\mathbf{h}}\exp(-E(\mathbf{v},\mathbf{h}))}\sum_{\mathbf{v},\mathbf{h}}\exp(-E(\mathbf{v},\mathbf{h}))\frac{\partial E(\mathbf{v},\mathbf{h})}{\partial \theta}\\
    &amp;&amp;=\sum_{\mathbf{h}}p_\theta(\mathbf{h}|\mathbf{v})\frac{\partial E(\mathbf{v},\mathbf{h})}{\partial \theta}-\sum_{\mathbf{v},\mathbf{h}}p_\theta(\mathbf{v},\mathbf{h})\frac{\partial E(\mathbf{v},\mathbf{h})}{\partial \theta}\tag{5}\label{eq:2}
\end{eqnarray}
\]</div>
</div>
<p>Eq. <span class="arithmatex">\(\eqref{eq:1}\)</span> is actually the same with Eq. <span class="arithmatex">\(\eqref{eq:2}\)</span> since</p>
<div class="arithmatex">\[
    F(\mathbf{v})=-\log\Big(\sum_{\mathbf{h}}\exp\big(-E(\mathbf{v},\mathbf{h})\big)\Big)
\]</div>
<p>%\bibliography{references}  %%% Remove comment to use the external .bib file (using bibtex).
%%% and comment out the ``thebibliography'' section.</p>
<p>%%% Comment out this section when you \bibliography{references} is enabled.</p>
<h3 id="rbm-training-algorithm"><span class="enumerate-headings-plugin enumerate-heading-plugin">1.2.2</span> RBM Training Algorithm</h3>
<div class="admonition note">
<p class="admonition-title">RBM Training Algorithm</p>
<p>Initialization for the <span class="arithmatex">\(\theta=\{\mathbf{W},\mathbf{b},\mathbf{c}\}\)</span></p>
<p>Fix the maximum number of epochs <span class="arithmatex">\(max\_epoch\)</span>, and mini-batch size <span class="arithmatex">\(M\)</span></p>
<p><strong>for</strong> <span class="arithmatex">\(i = 1,\ldots,{max\_epoch}\)</span> <strong>do</strong></p>
<p>    <strong>for</strong> <em>mini-batch</em> <span class="arithmatex">\(\mathrm{\mathbf{v}}_{mb}\)</span> <span class="arithmatex">\(\mathrm{\mathbf{in}}\)</span> Dataset <span class="arithmatex">\(\mathrm{\mathbf{D}}\)</span> <strong>do</strong></p>
<p>         <span class="arithmatex">\(\overline{\Delta\mathbf{W}}\)</span>, <span class="arithmatex">\(\overline{\Delta\mathbf{b}}\)</span>, <span class="arithmatex">\(\overline{\Delta\mathbf{c}}\)</span>~<span class="arithmatex">\(\gets\)</span>~<span class="arithmatex">\(\mathbf{0}\)</span>\;</p>
<p>        <strong>for</strong>  each data sample <span class="arithmatex">\(\mathrm{\mathbf{v}}\)</span> <span class="arithmatex">\(\mathrm{\mathbf{in}}\)</span> <span class="arithmatex">\(\mathrm{\mathbf{v}}_{mb}\)</span> <strong>do</strong></p>
<p>            <span class="arithmatex">\(\mathrm{\mathbf{v}}^{(0)} \gets \mathrm{\mathbf{v}}\)</span></p>
<p>            <strong>for</strong> <span class="arithmatex">\(t=0,\ldots,n-1\)</span> <strong>do</strong> </p>
<p>                Sample <span class="arithmatex">\(\mathbf{h}^{(t)}\)</span> <span class="arithmatex">\(\sim\)</span> <span class="arithmatex">\(p_{\theta}(\mathbf{h}|\mathbf{v}^{(t)})\)</span></p>
<p>                Sample <span class="arithmatex">\(\mathbf{v}^{(t+1)}\)</span> <span class="arithmatex">\(\sim\)</span> <span class="arithmatex">\(p_{\theta}(\mathbf{v}|\mathbf{h}^{(t)})\)</span> </p>
<p>            <strong>end</strong> </p>
<p>            Calculate the gradient <span class="arithmatex">\(\Delta\mathbf{W}\)</span>, <span class="arithmatex">\(\Delta\mathbf{b}\)</span>, and <span class="arithmatex">\(\Delta\mathbf{c}\)</span> according to Eq.<span class="arithmatex">\(\eqref{eq:g1}\)</span>~<span class="arithmatex">\(\eqref{eq:g2}\)</span>~<span class="arithmatex">\(\eqref{eq:g3}\)</span></p>
<p>           <span class="arithmatex">\(\overline{\Delta\mathbf{W}}\)</span>, <span class="arithmatex">\(\overline{\Delta\mathbf{b}}\)</span>, <span class="arithmatex">\(\overline{\Delta\mathbf{c}}\)</span> <span class="arithmatex">\(\gets\)</span> <span class="arithmatex">\(\overline{\Delta\mathbf{W}}+\Delta\mathbf{W}\)</span>, <span class="arithmatex">\(\overline{\Delta\mathbf{b}}+\Delta\mathbf{b}\)</span>, <span class="arithmatex">\(\overline{\Delta\mathbf{c}}+\Delta\mathbf{c}\)</span></p>
<p>         <strong>end</strong></p>
<p>         <span class="arithmatex">\(\mathbf{W}\)</span>, <span class="arithmatex">\(\mathbf{b}\)</span>, <span class="arithmatex">\(\mathbf{c}\)</span> <span class="arithmatex">\(\gets\)</span>
<span class="arithmatex">\(\mathbf{W}-\frac{1}{M}\overline{\Delta\mathbf{W}}\)</span>, <span class="arithmatex">\(\mathbf{b}-\frac{1}{M}\overline{\Delta\mathbf{b}}\)</span>, <span class="arithmatex">\(\mathbf{c}-\frac{1}{M}\overline{\Delta\mathbf{c}}\)</span></p>
<p>     <strong>end</strong></p>
<p><strong>end</strong></p>
</div>
<h3 id="implementation-in-python"><span class="enumerate-headings-plugin enumerate-heading-plugin">1.2.3</span> Implementation in Python</h3>
<div class="highlight"><span class="filename">RBM_vanila.py</span><pre><span></span><code><a href="#__codelineno-1-1" id="__codelineno-1-1" name="__codelineno-1-1"></a><span class="kn">import</span> <span class="nn">torch</span>
<a href="#__codelineno-1-2" id="__codelineno-1-2" name="__codelineno-1-2"></a><span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<a href="#__codelineno-1-3" id="__codelineno-1-3" name="__codelineno-1-3"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a href="#__codelineno-1-4" id="__codelineno-1-4" name="__codelineno-1-4"></a><span class="kn">import</span> <span class="nn">torchvision</span>
<a href="#__codelineno-1-5" id="__codelineno-1-5" name="__codelineno-1-5"></a><span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<a href="#__codelineno-1-6" id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<a href="#__codelineno-1-7" id="__codelineno-1-7" name="__codelineno-1-7"></a><span class="kn">import</span> <span class="nn">pickle</span>
<a href="#__codelineno-1-8" id="__codelineno-1-8" name="__codelineno-1-8"></a><span class="kn">import</span> <span class="nn">time</span>
<a href="#__codelineno-1-9" id="__codelineno-1-9" name="__codelineno-1-9"></a>
<a href="#__codelineno-1-10" id="__codelineno-1-10" name="__codelineno-1-10"></a><span class="k">class</span> <span class="nc">BinaryRBM</span><span class="p">():</span>
<a href="#__codelineno-1-11" id="__codelineno-1-11" name="__codelineno-1-11"></a>
<a href="#__codelineno-1-12" id="__codelineno-1-12" name="__codelineno-1-12"></a>    <span class="c1"># RBM Initialization</span>
<a href="#__codelineno-1-13" id="__codelineno-1-13" name="__codelineno-1-13"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_v</span><span class="p">,</span> <span class="n">num_h</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">"CPU"</span><span class="p">):</span>
<a href="#__codelineno-1-14" id="__codelineno-1-14" name="__codelineno-1-14"></a>
<a href="#__codelineno-1-15" id="__codelineno-1-15" name="__codelineno-1-15"></a>        <span class="sd">"""</span>
<a href="#__codelineno-1-16" id="__codelineno-1-16" name="__codelineno-1-16"></a><span class="sd">        Args:</span>
<a href="#__codelineno-1-17" id="__codelineno-1-17" name="__codelineno-1-17"></a><span class="sd">            num_v (int): the number of nodes in the visible layer</span>
<a href="#__codelineno-1-18" id="__codelineno-1-18" name="__codelineno-1-18"></a><span class="sd">            num_h (int): the number of nodes in the hidden layer </span>
<a href="#__codelineno-1-19" id="__codelineno-1-19" name="__codelineno-1-19"></a><span class="sd">            device (str): CPU or GPU mode</span>
<a href="#__codelineno-1-20" id="__codelineno-1-20" name="__codelineno-1-20"></a><span class="sd">        """</span>
<a href="#__codelineno-1-21" id="__codelineno-1-21" name="__codelineno-1-21"></a>
<a href="#__codelineno-1-22" id="__codelineno-1-22" name="__codelineno-1-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_v</span> <span class="o">=</span> <span class="n">num_v</span> <span class="c1"># the number of visible nodes</span>
<a href="#__codelineno-1-23" id="__codelineno-1-23" name="__codelineno-1-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_h</span> <span class="o">=</span> <span class="n">num_h</span> <span class="c1"># the number of hidden nodes</span>
<a href="#__codelineno-1-24" id="__codelineno-1-24" name="__codelineno-1-24"></a>
<a href="#__codelineno-1-25" id="__codelineno-1-25" name="__codelineno-1-25"></a>        <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s2">"GPU"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
<a href="#__codelineno-1-26" id="__codelineno-1-26" name="__codelineno-1-26"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"GPU is not supported"</span><span class="p">)</span>
<a href="#__codelineno-1-27" id="__codelineno-1-27" name="__codelineno-1-27"></a>        <span class="k">elif</span> <span class="n">device</span> <span class="o">==</span> <span class="s2">"GPU"</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
<a href="#__codelineno-1-28" id="__codelineno-1-28" name="__codelineno-1-28"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cuda"</span><span class="p">)</span>
<a href="#__codelineno-1-29" id="__codelineno-1-29" name="__codelineno-1-29"></a>        <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-1-30" id="__codelineno-1-30" name="__codelineno-1-30"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cpu"</span><span class="p">)</span>
<a href="#__codelineno-1-31" id="__codelineno-1-31" name="__codelineno-1-31"></a>
<a href="#__codelineno-1-32" id="__codelineno-1-32" name="__codelineno-1-32"></a>        <span class="c1"># normalization to ensure stability ? </span>
<a href="#__codelineno-1-33" id="__codelineno-1-33" name="__codelineno-1-33"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_h</span><span class="p">,</span> <span class="n">num_v</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_v</span><span class="p">)</span>
<a href="#__codelineno-1-34" id="__codelineno-1-34" name="__codelineno-1-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_v</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># bias (column) vector for the visible layer</span>
<a href="#__codelineno-1-35" id="__codelineno-1-35" name="__codelineno-1-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_h</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># bias (column) vector for the hidden layer</span>
<a href="#__codelineno-1-36" id="__codelineno-1-36" name="__codelineno-1-36"></a>
<a href="#__codelineno-1-37" id="__codelineno-1-37" name="__codelineno-1-37"></a>
<a href="#__codelineno-1-38" id="__codelineno-1-38" name="__codelineno-1-38"></a>
<a href="#__codelineno-1-39" id="__codelineno-1-39" name="__codelineno-1-39"></a>    <span class="c1"># Calculation of the free energy F(v)</span>
<a href="#__codelineno-1-40" id="__codelineno-1-40" name="__codelineno-1-40"></a>    <span class="k">def</span> <span class="nf">free_energy_func</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a href="#__codelineno-1-41" id="__codelineno-1-41" name="__codelineno-1-41"></a>        <span class="sd">"""</span>
<a href="#__codelineno-1-42" id="__codelineno-1-42" name="__codelineno-1-42"></a><span class="sd">        Args:</span>
<a href="#__codelineno-1-43" id="__codelineno-1-43" name="__codelineno-1-43"></a><span class="sd">        v (torch.Tensor): the visible states</span>
<a href="#__codelineno-1-44" id="__codelineno-1-44" name="__codelineno-1-44"></a>
<a href="#__codelineno-1-45" id="__codelineno-1-45" name="__codelineno-1-45"></a><span class="sd">        Returns:</span>
<a href="#__codelineno-1-46" id="__codelineno-1-46" name="__codelineno-1-46"></a><span class="sd">        free_energy (torch.Tensor): the free energy F(v) (c.f. Eq (12))</span>
<a href="#__codelineno-1-47" id="__codelineno-1-47" name="__codelineno-1-47"></a>
<a href="#__codelineno-1-48" id="__codelineno-1-48" name="__codelineno-1-48"></a><span class="sd">        """</span>
<a href="#__codelineno-1-49" id="__codelineno-1-49" name="__codelineno-1-49"></a>        <span class="c1"># c.f. Eq.(12)</span>
<a href="#__codelineno-1-50" id="__codelineno-1-50" name="__codelineno-1-50"></a>        <span class="c1"># .sum(0) represents the summation of different rows</span>
<a href="#__codelineno-1-51" id="__codelineno-1-51" name="__codelineno-1-51"></a>        <span class="c1"># F.softplus(x) calculates log(1+exp(x))</span>
<a href="#__codelineno-1-52" id="__codelineno-1-52" name="__codelineno-1-52"></a>
<a href="#__codelineno-1-53" id="__codelineno-1-53" name="__codelineno-1-53"></a>        <span class="k">return</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span><span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">addmm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="p">))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a href="#__codelineno-1-54" id="__codelineno-1-54" name="__codelineno-1-54"></a>
<a href="#__codelineno-1-55" id="__codelineno-1-55" name="__codelineno-1-55"></a>    <span class="k">def</span> <span class="nf">sample_h_given_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a href="#__codelineno-1-56" id="__codelineno-1-56" name="__codelineno-1-56"></a>        <span class="sd">"""</span>
<a href="#__codelineno-1-57" id="__codelineno-1-57" name="__codelineno-1-57"></a><span class="sd">          Args:</span>
<a href="#__codelineno-1-58" id="__codelineno-1-58" name="__codelineno-1-58"></a><span class="sd">        v (torch.Tensor): the visible states</span>
<a href="#__codelineno-1-59" id="__codelineno-1-59" name="__codelineno-1-59"></a>
<a href="#__codelineno-1-60" id="__codelineno-1-60" name="__codelineno-1-60"></a>
<a href="#__codelineno-1-61" id="__codelineno-1-61" name="__codelineno-1-61"></a><span class="sd">        Returns:</span>
<a href="#__codelineno-1-62" id="__codelineno-1-62" name="__codelineno-1-62"></a><span class="sd">        sampled_h (torch.Tensor): the sample h according to Eq.(17). </span>
<a href="#__codelineno-1-63" id="__codelineno-1-63" name="__codelineno-1-63"></a><span class="sd">                                  It is a column vector that contains 0 or 1. </span>
<a href="#__codelineno-1-64" id="__codelineno-1-64" name="__codelineno-1-64"></a>
<a href="#__codelineno-1-65" id="__codelineno-1-65" name="__codelineno-1-65"></a><span class="sd">        """</span>
<a href="#__codelineno-1-66" id="__codelineno-1-66" name="__codelineno-1-66"></a>
<a href="#__codelineno-1-67" id="__codelineno-1-67" name="__codelineno-1-67"></a>
<a href="#__codelineno-1-68" id="__codelineno-1-68" name="__codelineno-1-68"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">addmm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">()</span><span class="o">&gt;</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_h</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="c1"># c.f. Eq (17)</span>
<a href="#__codelineno-1-69" id="__codelineno-1-69" name="__codelineno-1-69"></a>
<a href="#__codelineno-1-70" id="__codelineno-1-70" name="__codelineno-1-70"></a>    <span class="k">def</span> <span class="nf">sample_v_given_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
<a href="#__codelineno-1-71" id="__codelineno-1-71" name="__codelineno-1-71"></a>        <span class="sd">"""</span>
<a href="#__codelineno-1-72" id="__codelineno-1-72" name="__codelineno-1-72"></a><span class="sd">        Args:</span>
<a href="#__codelineno-1-73" id="__codelineno-1-73" name="__codelineno-1-73"></a><span class="sd">        h (torch.Tensor): the hidden states</span>
<a href="#__codelineno-1-74" id="__codelineno-1-74" name="__codelineno-1-74"></a>
<a href="#__codelineno-1-75" id="__codelineno-1-75" name="__codelineno-1-75"></a><span class="sd">        Returns:</span>
<a href="#__codelineno-1-76" id="__codelineno-1-76" name="__codelineno-1-76"></a><span class="sd">        sampled_v (torch.Tensor): the sample v according to Eq.(18). </span>
<a href="#__codelineno-1-77" id="__codelineno-1-77" name="__codelineno-1-77"></a><span class="sd">                                  It is a column vector that contains 0 or 1. </span>
<a href="#__codelineno-1-78" id="__codelineno-1-78" name="__codelineno-1-78"></a>
<a href="#__codelineno-1-79" id="__codelineno-1-79" name="__codelineno-1-79"></a><span class="sd">        """</span>
<a href="#__codelineno-1-80" id="__codelineno-1-80" name="__codelineno-1-80"></a>
<a href="#__codelineno-1-81" id="__codelineno-1-81" name="__codelineno-1-81"></a>
<a href="#__codelineno-1-82" id="__codelineno-1-82" name="__codelineno-1-82"></a>        <span class="k">return</span> <span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">addmm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span> <span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">()</span><span class="o">&gt;</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_v</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="c1"># c.f. Eq (18)</span>
<a href="#__codelineno-1-83" id="__codelineno-1-83" name="__codelineno-1-83"></a>
<a href="#__codelineno-1-84" id="__codelineno-1-84" name="__codelineno-1-84"></a>
<a href="#__codelineno-1-85" id="__codelineno-1-85" name="__codelineno-1-85"></a>    <span class="k">def</span> <span class="nf">block_gibbs_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_v</span><span class="p">,</span> <span class="n">num_iter</span><span class="p">):</span>
<a href="#__codelineno-1-86" id="__codelineno-1-86" name="__codelineno-1-86"></a>        <span class="sd">"""</span>
<a href="#__codelineno-1-87" id="__codelineno-1-87" name="__codelineno-1-87"></a><span class="sd">        Args:</span>
<a href="#__codelineno-1-88" id="__codelineno-1-88" name="__codelineno-1-88"></a><span class="sd">        initial_v (torch.Tensor): the initial visible states to start the block gibbs sampling</span>
<a href="#__codelineno-1-89" id="__codelineno-1-89" name="__codelineno-1-89"></a><span class="sd">        num_iter(int): the number of iterations for the gibbs sampling</span>
<a href="#__codelineno-1-90" id="__codelineno-1-90" name="__codelineno-1-90"></a>
<a href="#__codelineno-1-91" id="__codelineno-1-91" name="__codelineno-1-91"></a><span class="sd">        Returns:</span>
<a href="#__codelineno-1-92" id="__codelineno-1-92" name="__codelineno-1-92"></a><span class="sd">        gibbs_v (torch.Tensor): the sampled visible states</span>
<a href="#__codelineno-1-93" id="__codelineno-1-93" name="__codelineno-1-93"></a><span class="sd">        """</span>
<a href="#__codelineno-1-94" id="__codelineno-1-94" name="__codelineno-1-94"></a>        <span class="n">v</span> <span class="o">=</span> <span class="n">initial_v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a href="#__codelineno-1-95" id="__codelineno-1-95" name="__codelineno-1-95"></a>
<a href="#__codelineno-1-96" id="__codelineno-1-96" name="__codelineno-1-96"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iter</span><span class="p">):</span>
<a href="#__codelineno-1-97" id="__codelineno-1-97" name="__codelineno-1-97"></a>
<a href="#__codelineno-1-98" id="__codelineno-1-98" name="__codelineno-1-98"></a>            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_h_given_v</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a href="#__codelineno-1-99" id="__codelineno-1-99" name="__codelineno-1-99"></a>            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_v_given_h</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a href="#__codelineno-1-100" id="__codelineno-1-100" name="__codelineno-1-100"></a>
<a href="#__codelineno-1-101" id="__codelineno-1-101" name="__codelineno-1-101"></a>        <span class="k">return</span> <span class="n">v</span>
<a href="#__codelineno-1-102" id="__codelineno-1-102" name="__codelineno-1-102"></a>
<a href="#__codelineno-1-103" id="__codelineno-1-103" name="__codelineno-1-103"></a>    <span class="k">def</span> <span class="nf">free_energy_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
<a href="#__codelineno-1-104" id="__codelineno-1-104" name="__codelineno-1-104"></a>        <span class="sd">"""</span>
<a href="#__codelineno-1-105" id="__codelineno-1-105" name="__codelineno-1-105"></a><span class="sd">        Args:</span>
<a href="#__codelineno-1-106" id="__codelineno-1-106" name="__codelineno-1-106"></a><span class="sd">        v (torch.Tensor): the visible states</span>
<a href="#__codelineno-1-107" id="__codelineno-1-107" name="__codelineno-1-107"></a>
<a href="#__codelineno-1-108" id="__codelineno-1-108" name="__codelineno-1-108"></a><span class="sd">        Returns:</span>
<a href="#__codelineno-1-109" id="__codelineno-1-109" name="__codelineno-1-109"></a><span class="sd">        grad_w (torch.Tensor): the average gradient of the free energy with respect to w across all samples</span>
<a href="#__codelineno-1-110" id="__codelineno-1-110" name="__codelineno-1-110"></a><span class="sd">        grad_b (torch.Tensor): the average gradient of the free energy with respect to b across all samples</span>
<a href="#__codelineno-1-111" id="__codelineno-1-111" name="__codelineno-1-111"></a><span class="sd">        grad_c (torch.Tensor): the average gradient of the free energy with respect to c across all samples</span>
<a href="#__codelineno-1-112" id="__codelineno-1-112" name="__codelineno-1-112"></a>
<a href="#__codelineno-1-113" id="__codelineno-1-113" name="__codelineno-1-113"></a><span class="sd">        """</span>
<a href="#__codelineno-1-114" id="__codelineno-1-114" name="__codelineno-1-114"></a>        <span class="n">temp</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">addmm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span><span class="n">v</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">()</span>
<a href="#__codelineno-1-115" id="__codelineno-1-115" name="__codelineno-1-115"></a>
<a href="#__codelineno-1-116" id="__codelineno-1-116" name="__codelineno-1-116"></a>        <span class="n">grad_c</span> <span class="o">=</span>  <span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-1-117" id="__codelineno-1-117" name="__codelineno-1-117"></a>        <span class="n">grad_b</span> <span class="o">=</span> <span class="o">-</span> <span class="n">v</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-1-118" id="__codelineno-1-118" name="__codelineno-1-118"></a>        <span class="n">grad_w</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">t</span><span class="p">())</span><span class="o">/</span><span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-1-119" id="__codelineno-1-119" name="__codelineno-1-119"></a>
<a href="#__codelineno-1-120" id="__codelineno-1-120" name="__codelineno-1-120"></a>
<a href="#__codelineno-1-121" id="__codelineno-1-121" name="__codelineno-1-121"></a>        <span class="k">return</span> <span class="n">grad_w</span><span class="p">,</span> <span class="n">grad_b</span><span class="p">,</span> <span class="n">grad_c</span>
<a href="#__codelineno-1-122" id="__codelineno-1-122" name="__codelineno-1-122"></a>
<a href="#__codelineno-1-123" id="__codelineno-1-123" name="__codelineno-1-123"></a>    <span class="k">def</span> <span class="nf">mini_batch_gradient_func</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">cd_k</span><span class="p">):</span>
<a href="#__codelineno-1-124" id="__codelineno-1-124" name="__codelineno-1-124"></a>
<a href="#__codelineno-1-125" id="__codelineno-1-125" name="__codelineno-1-125"></a>        <span class="sd">"""</span>
<a href="#__codelineno-1-126" id="__codelineno-1-126" name="__codelineno-1-126"></a><span class="sd">        Args:</span>
<a href="#__codelineno-1-127" id="__codelineno-1-127" name="__codelineno-1-127"></a><span class="sd">        v (torch.Tensor): the visible states</span>
<a href="#__codelineno-1-128" id="__codelineno-1-128" name="__codelineno-1-128"></a><span class="sd">        cd_k (int): cd_k mode that is chosen</span>
<a href="#__codelineno-1-129" id="__codelineno-1-129" name="__codelineno-1-129"></a>
<a href="#__codelineno-1-130" id="__codelineno-1-130" name="__codelineno-1-130"></a><span class="sd">        Returns:</span>
<a href="#__codelineno-1-131" id="__codelineno-1-131" name="__codelineno-1-131"></a><span class="sd">        grad_mini_batch (Torch) the average gradient across all samples in the mini-batch</span>
<a href="#__codelineno-1-132" id="__codelineno-1-132" name="__codelineno-1-132"></a><span class="sd">        """</span>
<a href="#__codelineno-1-133" id="__codelineno-1-133" name="__codelineno-1-133"></a>        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># move to GPU if necessary </span>
<a href="#__codelineno-1-134" id="__codelineno-1-134" name="__codelineno-1-134"></a>
<a href="#__codelineno-1-135" id="__codelineno-1-135" name="__codelineno-1-135"></a>        <span class="n">v_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_gibbs_sampling</span><span class="p">(</span><span class="n">initial_v</span> <span class="o">=</span> <span class="n">v</span><span class="p">,</span> <span class="n">num_iter</span> <span class="o">=</span> <span class="n">cd_k</span><span class="p">)</span>
<a href="#__codelineno-1-136" id="__codelineno-1-136" name="__codelineno-1-136"></a>
<a href="#__codelineno-1-137" id="__codelineno-1-137" name="__codelineno-1-137"></a>        <span class="p">[</span><span class="n">grad_w_pos</span><span class="p">,</span> <span class="n">grad_b_pos</span><span class="p">,</span> <span class="n">grad_c_pos</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_energy_gradient</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
<a href="#__codelineno-1-138" id="__codelineno-1-138" name="__codelineno-1-138"></a>        <span class="p">[</span><span class="n">grad_w_neg</span><span class="p">,</span> <span class="n">grad_b_neg</span><span class="p">,</span> <span class="n">grad_c_neg</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_energy_gradient</span><span class="p">(</span><span class="n">v_k</span><span class="p">)</span>
<a href="#__codelineno-1-139" id="__codelineno-1-139" name="__codelineno-1-139"></a>
<a href="#__codelineno-1-140" id="__codelineno-1-140" name="__codelineno-1-140"></a>        <span class="k">return</span> <span class="n">grad_w_pos</span> <span class="o">-</span> <span class="n">grad_w_neg</span><span class="p">,</span> <span class="n">grad_b_pos</span> <span class="o">-</span> <span class="n">grad_b_neg</span><span class="p">,</span> <span class="n">grad_c_pos</span> <span class="o">-</span> <span class="n">grad_c_neg</span> <span class="c1"># c.f. Eq.(13)</span>
<a href="#__codelineno-1-141" id="__codelineno-1-141" name="__codelineno-1-141"></a>
<a href="#__codelineno-1-142" id="__codelineno-1-142" name="__codelineno-1-142"></a>
<a href="#__codelineno-1-143" id="__codelineno-1-143" name="__codelineno-1-143"></a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">,</span> <span class="n">cd_k</span><span class="p">,</span> <span class="n">max_epochs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
<a href="#__codelineno-1-144" id="__codelineno-1-144" name="__codelineno-1-144"></a>        <span class="sd">"""</span>
<a href="#__codelineno-1-145" id="__codelineno-1-145" name="__codelineno-1-145"></a><span class="sd">        Args:</span>
<a href="#__codelineno-1-146" id="__codelineno-1-146" name="__codelineno-1-146"></a><span class="sd">        dataloader: dataloader of the training data </span>
<a href="#__codelineno-1-147" id="__codelineno-1-147" name="__codelineno-1-147"></a><span class="sd">        cd_k: the contrastive divergence mode</span>
<a href="#__codelineno-1-148" id="__codelineno-1-148" name="__codelineno-1-148"></a><span class="sd">        max_epochs: number of epochs</span>
<a href="#__codelineno-1-149" id="__codelineno-1-149" name="__codelineno-1-149"></a><span class="sd">        lr: the learning rate</span>
<a href="#__codelineno-1-150" id="__codelineno-1-150" name="__codelineno-1-150"></a>
<a href="#__codelineno-1-151" id="__codelineno-1-151" name="__codelineno-1-151"></a><span class="sd">        Returns:</span>
<a href="#__codelineno-1-152" id="__codelineno-1-152" name="__codelineno-1-152"></a><span class="sd">        w, b, c: the parameters of the RBM</span>
<a href="#__codelineno-1-153" id="__codelineno-1-153" name="__codelineno-1-153"></a><span class="sd">        """</span>
<a href="#__codelineno-1-154" id="__codelineno-1-154" name="__codelineno-1-154"></a>        <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_epochs</span><span class="p">):</span>
<a href="#__codelineno-1-155" id="__codelineno-1-155" name="__codelineno-1-155"></a>
<a href="#__codelineno-1-156" id="__codelineno-1-156" name="__codelineno-1-156"></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">'Epoch </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">))</span>
<a href="#__codelineno-1-157" id="__codelineno-1-157" name="__codelineno-1-157"></a>
<a href="#__codelineno-1-158" id="__codelineno-1-158" name="__codelineno-1-158"></a>            <span class="k">for</span> <span class="n">mini_batch_samples</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
<a href="#__codelineno-1-159" id="__codelineno-1-159" name="__codelineno-1-159"></a>                <span class="n">mini_batch_samples_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">mini_batch_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">start_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">t</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
<a href="#__codelineno-1-160" id="__codelineno-1-160" name="__codelineno-1-160"></a>                <span class="n">grad_w</span><span class="p">,</span> <span class="n">grad_b</span><span class="p">,</span> <span class="n">grad_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_gradient_func</span><span class="p">(</span><span class="n">mini_batch_samples_</span><span class="p">,</span> <span class="n">cd_k</span><span class="p">)</span>
<a href="#__codelineno-1-161" id="__codelineno-1-161" name="__codelineno-1-161"></a>
<a href="#__codelineno-1-162" id="__codelineno-1-162" name="__codelineno-1-162"></a>
<a href="#__codelineno-1-163" id="__codelineno-1-163" name="__codelineno-1-163"></a>                <span class="c1"># update w, b, c</span>
<a href="#__codelineno-1-164" id="__codelineno-1-164" name="__codelineno-1-164"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">w</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">grad_w</span>
<a href="#__codelineno-1-165" id="__codelineno-1-165" name="__codelineno-1-165"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">grad_b</span>
<a href="#__codelineno-1-166" id="__codelineno-1-166" name="__codelineno-1-166"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">grad_c</span>
<a href="#__codelineno-1-167" id="__codelineno-1-167" name="__codelineno-1-167"></a>            <span class="c1"># break</span>
<a href="#__codelineno-1-168" id="__codelineno-1-168" name="__codelineno-1-168"></a>            <span class="nb">print</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">))</span>
<a href="#__codelineno-1-169" id="__codelineno-1-169" name="__codelineno-1-169"></a>
<a href="#__codelineno-1-170" id="__codelineno-1-170" name="__codelineno-1-170"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
<a href="#__codelineno-1-171" id="__codelineno-1-171" name="__codelineno-1-171"></a>
<a href="#__codelineno-1-172" id="__codelineno-1-172" name="__codelineno-1-172"></a>
<a href="#__codelineno-1-173" id="__codelineno-1-173" name="__codelineno-1-173"></a>
<a href="#__codelineno-1-174" id="__codelineno-1-174" name="__codelineno-1-174"></a>
<a href="#__codelineno-1-175" id="__codelineno-1-175" name="__codelineno-1-175"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a href="#__codelineno-1-176" id="__codelineno-1-176" name="__codelineno-1-176"></a>
<a href="#__codelineno-1-177" id="__codelineno-1-177" name="__codelineno-1-177"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">BinaryRBM</span><span class="p">(</span><span class="mi">784</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="s2">"CPU"</span><span class="p">)</span>
<a href="#__codelineno-1-178" id="__codelineno-1-178" name="__codelineno-1-178"></a>
<a href="#__codelineno-1-179" id="__codelineno-1-179" name="__codelineno-1-179"></a>    <span class="c1"># Load Data</span>
<a href="#__codelineno-1-180" id="__codelineno-1-180" name="__codelineno-1-180"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="s2">"~"</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a href="#__codelineno-1-181" id="__codelineno-1-181" name="__codelineno-1-181"></a>    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span><span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<a href="#__codelineno-1-182" id="__codelineno-1-182" name="__codelineno-1-182"></a>
<a href="#__codelineno-1-183" id="__codelineno-1-183" name="__codelineno-1-183"></a>    <span class="c1"># Train</span>
<a href="#__codelineno-1-184" id="__codelineno-1-184" name="__codelineno-1-184"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a href="#__codelineno-1-185" id="__codelineno-1-185" name="__codelineno-1-185"></a>    <span class="n">w</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">cd_k</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
<a href="#__codelineno-1-186" id="__codelineno-1-186" name="__codelineno-1-186"></a>    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a href="#__codelineno-1-187" id="__codelineno-1-187" name="__codelineno-1-187"></a>
<a href="#__codelineno-1-188" id="__codelineno-1-188" name="__codelineno-1-188"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'objs.pkl'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Python 3: open(..., 'wb')</span>
<a href="#__codelineno-1-189" id="__codelineno-1-189" name="__codelineno-1-189"></a>        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">b</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span><span class="n">c</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()],</span> <span class="n">f</span><span class="p">)</span>
<a href="#__codelineno-1-190" id="__codelineno-1-190" name="__codelineno-1-190"></a>
<a href="#__codelineno-1-191" id="__codelineno-1-191" name="__codelineno-1-191"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"Training Ended. Elapsed Time is </span><span class="si">{0:.2f}</span><span class="s2">s"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">))</span>
<a href="#__codelineno-1-192" id="__codelineno-1-192" name="__codelineno-1-192"></a>
<a href="#__codelineno-1-193" id="__codelineno-1-193" name="__codelineno-1-193"></a>
<a href="#__codelineno-1-194" id="__codelineno-1-194" name="__codelineno-1-194"></a>
<a href="#__codelineno-1-195" id="__codelineno-1-195" name="__codelineno-1-195"></a>    <span class="c1"># Test </span>
<a href="#__codelineno-1-196" id="__codelineno-1-196" name="__codelineno-1-196"></a>
<a href="#__codelineno-1-197" id="__codelineno-1-197" name="__codelineno-1-197"></a>    <span class="c1"># retrieve the next image data for testing </span>
<a href="#__codelineno-1-198" id="__codelineno-1-198" name="__codelineno-1-198"></a>    <span class="n">i</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a href="#__codelineno-1-199" id="__codelineno-1-199" name="__codelineno-1-199"></a>
<a href="#__codelineno-1-200" id="__codelineno-1-200" name="__codelineno-1-200"></a>    <span class="c1"># Generate new visible states with a random initial visible states via Gibbs sampling the RBM</span>
<a href="#__codelineno-1-201" id="__codelineno-1-201" name="__codelineno-1-201"></a>    <span class="n">v_gen</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">block_gibbs_sampling</span><span class="p">(</span><span class="n">initial_v</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(),</span><span class="n">num_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span>
<a href="#__codelineno-1-202" id="__codelineno-1-202" name="__codelineno-1-202"></a>
<a href="#__codelineno-1-203" id="__codelineno-1-203" name="__codelineno-1-203"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-1-204" id="__codelineno-1-204" name="__codelineno-1-204"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<a href="#__codelineno-1-205" id="__codelineno-1-205" name="__codelineno-1-205"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(),</span><span class="n">cmap</span> <span class="o">=</span> <span class="s2">"gray"</span><span class="p">)</span>
<a href="#__codelineno-1-206" id="__codelineno-1-206" name="__codelineno-1-206"></a>
<a href="#__codelineno-1-207" id="__codelineno-1-207" name="__codelineno-1-207"></a>    <span class="c1"># Display the images</span>
<a href="#__codelineno-1-208" id="__codelineno-1-208" name="__codelineno-1-208"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<a href="#__codelineno-1-209" id="__codelineno-1-209" name="__codelineno-1-209"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">v_gen</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span><span class="n">cmap</span> <span class="o">=</span> <span class="s2">"gray"</span><span class="p">)</span>
<a href="#__codelineno-1-210" id="__codelineno-1-210" name="__codelineno-1-210"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<h2 id="binary-conditional-rbm"><span class="enumerate-headings-plugin enumerate-heading-plugin">1.3</span> Binary Conditional RBM</h2>
<p>Conditional RBM is a generalization of Vanilla RBM discussed in Section 2. In Conditional RBM, we have some extra <span class="arithmatex">\(R\)</span> label nodes, represented by <span class="arithmatex">\(\mathbf{r}\)</span>, where every label node is connected with every hidden node, with no connection among themselves. </p>
<p><span class="arithmatex">\(E_{\theta,\mathbf{r}}(\mathbf{v}, \mathbf{h})\)</span> is the energy function calculated by </p>
<div class="arithmatex">\[
\begin{eqnarray}
&amp;\nonumber E_{\theta,\mathbf{r}}(\mathbf{v},\mathbf{h}) &amp; =  -\mathbf{h}^T\mathbf{W}\mathbf{v}-\mathbf{h}^T\mathbf{W}^{'}\mathbf{r}-\mathbf{b}^T\mathbf{v}-\mathbf{c}^T\mathbf{h}\\
&amp;\nonumber &amp;= -\mathbf{h}^T\mathbf{W}\mathbf{v}-\mathbf{b}^T\mathbf{v}-(\mathbf{W}^{'}\mathbf{r}+\mathbf{c})^T\mathbf{h}\\
&amp;&amp;=-\sum_{j}\sum_k h_j W_{j,k} v_k - \sum_k b_k v_k - \sum_{j}\ h_j (\sum_i W_{j,i}^{'} r_i + c_j)
\end{eqnarray}
\]</div>
<p>where <span class="arithmatex">\(\mathbf{r}\)</span> is fixed. Now let's calculate some probability distribution functions in advance. </p>
<div class="arithmatex">\[
\begin{eqnarray}
    &amp;p_{\theta,\mathbf{r}}(\mathbf{v})&amp;=\sum_{\mathbf{h}}p_{\theta,\mathbf{r}}(\mathbf{v},\mathbf{h})\\
    &amp;\nonumber &amp;=\sum_{\mathbf{h}}\frac{1}{Z}\exp(-E_{\theta,\mathbf{r}}(\mathbf{v},\mathbf{h}))\\
    &amp;\nonumber &amp;=\sum_{\mathbf{h}}\frac{1}{Z}\exp(\mathbf{h}^T\mathbf{W}\mathbf{v}+\mathbf{b}^T\mathbf{v}+(\mathbf{W}^{'}\mathbf{r}+\mathbf{c})^T\mathbf{h})\\
    &amp;\nonumber &amp;=\frac{1}{Z}\exp(\mathbf{b}^T\mathbf{v})\sum_{\mathbf{h}}\exp(\mathbf{h}^T\mathbf{W}\mathbf{v}+(\mathbf{W}^{'}\mathbf{r}+\mathbf{c})^T\mathbf{h})\\
     &amp;\nonumber &amp;=\frac{1}{Z}\exp(\mathbf{b}^T\mathbf{v})\sum_{\mathbf{h}}\exp(\sum_{j=1}^{H}(h_j W_{j,:}\mathbf{v}+(W_{j,:}^{'}\mathbf{r}+c_j) h_j))\\
     &amp;\nonumber &amp;=\frac{1}{Z}\exp(\mathbf{b}^T\mathbf{v})\sum_{h_1\in\{0,1\}}\exp(h_1W_{1,:}\mathbf{v}+(W_{1,:}^{'}\mathbf{r}+c_1)h_1) ~\ldots~\sum_{h_H\in\{0,1\}} \exp(h_H W_{H,:}\mathbf{v}+(W_{H,:}^{'}\mathbf{r}+c_H) h_H)\\
     &amp;\nonumber &amp;=\frac{1}{Z}\exp(\mathbf{b}^T\mathbf{v})\prod_j(1+\exp(W_{j,:}\mathbf{v}+W_{j,:}^{'} \mathbf{r}+c_j))\\
     &amp;\nonumber &amp;=\frac{1}{Z}\exp(-F_{\mathbf{r}}(\mathbf{v}))
\end{eqnarray}
\]</div>
<p>where </p>
<div class="arithmatex">\[
\begin{eqnarray}
F_{\mathbf{r}}(\mathbf{v})=-\mathbf{b}^T\mathbf{v}-\sum_{j=1}^{H}\log (1+\exp(W_{j,:}\mathbf{v}+W_{j,:}^{'}\mathbf{r}+c_j)))
\end{eqnarray}
\]</div>
<div class="arithmatex">\[
\begin{eqnarray}
&amp;\nonumber p_{\theta,\mathbf{r}}(\mathbf{h}|\mathbf{v})&amp;=\frac{p_{\theta,\mathbf{r}}(\mathbf{v},\mathbf{h}) }{p_{\theta,\mathbf{r}}(\mathbf{v})}\\
&amp;\nonumber &amp;=\frac{\exp(-E_{\theta,\mathbf{r}}(\mathbf{v},\mathbf{h}))}{\sum_{\mathbf{h}}\exp(-E_{\theta,\mathbf{r}}(\mathbf{v},\mathbf{h}))}\\
&amp;\nonumber &amp;=\frac{\exp(\mathbf{h}^T\mathbf{W}\mathbf{v}+\mathbf{h}^T(\mathbf{W}^{'}\mathbf{r}+\mathbf{c}))}{\sum_{\mathbf{h}}\exp(\mathbf{h}^T\mathbf{W}\mathbf{v}+\mathbf{h}^T(\mathbf{W}^{'}\mathbf{r}+\mathbf{c}))}\\
&amp;\nonumber &amp;=\frac{\exp(\sum_j(h_j (W_{j,:}\mathbf{v}+W_{j,:}^{'} \mathbf{r}+c_j)))}{\sum_{h_1}\ldots\sum_{h_H}\exp(\sum_j(h_j (W_{j,:}\mathbf{v}+W_{j,:}^{'} \mathbf{r}+c_j)))}\\
&amp;\nonumber &amp;=\frac{\prod_j\exp(h_j (W_{j,:}\mathbf{v}+W_{j,:}^{'} \mathbf{r}+c_j))}{(\sum_{h_1}\exp(h_1 (W_{1,:}\mathbf{v}+W_{1,:}^{'} \mathbf{r}+c_1)))\ldots(\sum_{h_H}\exp(h_H (W_{H,:}\mathbf{v}+W_{H,:}^{'} \mathbf{r}+c_H))}\\
&amp;\nonumber &amp;=\prod_j\frac{\exp(h_j (W_{j,:}\mathbf{v}+W_{j,:}^{'} \mathbf{r}+c_j))}{1+\exp(W_{j,:}\mathbf{v}+W_{j,:}^{'} \mathbf{r}+c_j)}\\
&amp;&amp;=\prod_j p_{\theta,\mathbf{r}} (h_j|\mathbf{v})\\
&amp;\nonumber p_{\theta,\mathbf{r}}(\mathbf{v}|\mathbf{h})&amp;=\frac{p_{\theta,\mathbf{r}}(\mathbf{v},\mathbf{h}) }{p_{\theta,\mathbf{r}}(\mathbf{h})}\\
&amp;\nonumber &amp;=\frac{\exp(-E_{\theta,\mathbf{r}}(\mathbf{v},\mathbf{h}))}{\sum_{\mathbf{v}}\exp(-E_{\theta,\mathbf{r}}(\mathbf{v},\mathbf{h}))}\\
&amp;\nonumber &amp;=\frac{\exp(\mathbf{v}^T\mathbf{W}^T\mathbf{h}+\mathbf{v}^T\mathbf{b})}{\sum_{\mathbf{v}}\exp(\mathbf{v}^T\mathbf{W}^T\mathbf{h}+\mathbf{v}^T\mathbf{b})}\\
&amp;\nonumber &amp;=\frac{\exp(\sum_k(v_k W_{:,k}^T\mathbf{h}+v_kb_k))}{\sum_{h_1}\ldots\sum_{h_H}\exp(\sum_j(h_j W_{j,:}\mathbf{v}+c_jh_j))}\\
&amp;\nonumber &amp;=\frac{\prod_k\exp(v_k W_{:,k}^T\mathbf{h}+v_kb_k)}{(\sum_{v_1}\exp(v_1 W_{:,1}^T\mathbf{h}+v_1b_1))\ldots(\sum_{v_V}\exp(v_V W_{:,V}^T\mathbf{h}+v_Vb_V)}\\
&amp;\nonumber &amp;=\prod_k\frac{\exp(v_k W_{:,k}^T\mathbf{h}+v_kb_k)}{1+\exp( W_{:,k}^T\mathbf{h}+b_k)}\\
&amp;&amp;=\prod_k p_\theta (v_k|\mathbf{h})
\end{eqnarray}
\]</div>
<p>Define <span class="arithmatex">\(\theta=\{\mathbf{W},\mathbf{W}^{'},\mathbf{b},\mathbf{c}\}\)</span>, we will have</p>
<div class="arithmatex">\[
\begin{eqnarray}
  -\frac{\partial \log p_{\mathbf{\theta},\mathbf{r}}(\mathbf{v})}{\partial \mathbf{\theta}}&amp;=-\frac{\partial }{\partial \theta}\Big(\log\frac{\exp(-F_{\mathbf{r}}(\mathbf{v}))}{Z}\Big)=\frac{\partial F_\mathbf{r}(\mathbf{v})}{\partial \theta}-\mathbb{E}_{\mathbf{v}^\prime}\Big[\frac{\partial F_\mathbf{r}(\mathbf{v}^\prime)}{\partial \theta}\Big]\tag{5}\label{eq:1}
\end{eqnarray}
\]</div>
<p>with <span class="arithmatex">\(\mathbf{v}^\prime \sim p_{\theta,\mathbf{r}}(\mathbf{v}^\prime)\)</span>. while $ \frac{\partial F(\mathbf{v})}{\partial \theta}$ can be expressed as</p>
<div class="arithmatex">\[
\begin{eqnarray}
    \nonumber &amp;\frac{\partial F_{\mathbf{r}}(\mathbf{v})}{\partial w_{j,k}} = -p_{\theta,\mathbf{r}}(h_j=1|\mathbf{v})v_k\\
    \nonumber &amp;\frac{\partial F_{\mathbf{r}}(\mathbf{v})}{\partial w_{j,i}^{'}} = -p_{\theta,\mathbf{r}}(h_j=1|\mathbf{v})r_i\\
     \nonumber &amp;\frac{\partial F_{\mathbf{r}}(\mathbf{v})}{\partial \mathbf{b}} = -\mathbf{v}\\
     \nonumber &amp;\frac{\partial F_{\mathbf{r}}(\mathbf{v})}{\partial \mathbf{c}} = -p_{\theta,\mathbf{r}}(h_j=1|\mathbf{v})
\end{eqnarray}
\]</div>
<p>In a similar fashion, we can use Contrastive Divergence to approximate the second Expectation term. </p>
<div class="arithmatex">\[
\begin{eqnarray}
    &amp;-\frac{\partial \log p_{\theta,\mathbf{r}}(\mathbf{v})}{\partial w_{j,k}}=
-p_{\theta,\mathbf{r}}(h_j=1|\mathbf{v})v_k+p_{\theta,\mathbf{r}}(h_j=1|\mathbf{v}^n)v_k^n \\
&amp;-\frac{\partial \log p_{\theta,\mathbf{r}}(\mathbf{v})}{\partial w_{j,i}^{'}}=
-p_{\theta,\mathbf{r}}(h_j=1|\mathbf{v})r_i+p_{\theta,\mathbf{r}}(h_j=1|\mathbf{v}^n)r_i \\
&amp;-\frac{\partial \log p_{\mathbf{\theta},\mathbf{r}}(\mathbf{v})}{\partial \mathbf{b}} = -\mathbf{v}+\mathbf{v}^n\\
&amp;-\frac{\partial \log p_{\mathbf{\theta},\mathbf{r}}(\mathbf{v})}{\partial \mathbf{c}} = -p_{\theta,\mathbf{r}}(h_j=1|\mathbf{v})+p_{\theta,\mathbf{r}}(h_j=1|\mathbf{v}^n)
\end{eqnarray}
\]</div>
<p>Where <span class="arithmatex">\(\mathbf{v}^n\)</span> is obtained after <span class="arithmatex">\(n\)</span> iterations of block Gibbs Sampling below. </p>
<div class="admonition note">
<p class="admonition-title">Gibbs Sampling</p>
<ol>
<li>Initialization: <span class="arithmatex">\(\mathbf{v}^{\mathrm{train}}\)</span></li>
<li>Find: <span class="arithmatex">\(p_{\theta,\mathbf{r}^{\mathrm{train}}}(\mathbf{h}^1| \mathbf{v}^{\mathrm{train}})\)</span></li>
<li>Sample <span class="arithmatex">\(\mathbf{h}^1\sim p_{\theta,\mathbf{r}^{\mathrm{train}}}(\mathbf{h}^1| \mathbf{v}^{\mathrm{train}})\)</span></li>
<li>Find: <span class="arithmatex">\(p_{\theta,\mathbf{r}^{\mathrm{train}}}(\mathbf{v}^1| \mathbf{h}^1)\)</span></li>
<li>Sample: <span class="arithmatex">\(\mathbf{v}^1 \sim p_{\theta,\mathbf{r}^{\mathrm{train}}}(\mathbf{v}^1| \mathbf{h}^1)\)</span></li>
</ol>
<div class="highlight"><pre><span></span><code><a href="#__codelineno-2-1" id="__codelineno-2-1" name="__codelineno-2-1"></a>... 
</code></pre></div>
</div>
<p>where <span class="arithmatex">\(\mathbf{r}^\mathrm{train}\)</span> is the corresponding label for <span class="arithmatex">\(\mathbf{v}^{\mathrm{train}}\)</span>. </p>
<h3 id="implementation-in-python_1"><span class="enumerate-headings-plugin enumerate-heading-plugin">1.3.1</span> Implementation in Python</h3>
<div class="highlight"><span class="filename">Conditional_RBM.py</span><pre><span></span><code><a href="#__codelineno-3-1" id="__codelineno-3-1" name="__codelineno-3-1"></a><span class="kn">import</span> <span class="nn">torch</span>
<a href="#__codelineno-3-2" id="__codelineno-3-2" name="__codelineno-3-2"></a><span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="nn">F</span>
<a href="#__codelineno-3-3" id="__codelineno-3-3" name="__codelineno-3-3"></a><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<a href="#__codelineno-3-4" id="__codelineno-3-4" name="__codelineno-3-4"></a><span class="kn">import</span> <span class="nn">torchvision</span>
<a href="#__codelineno-3-5" id="__codelineno-3-5" name="__codelineno-3-5"></a><span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span>
<a href="#__codelineno-3-6" id="__codelineno-3-6" name="__codelineno-3-6"></a><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<a href="#__codelineno-3-7" id="__codelineno-3-7" name="__codelineno-3-7"></a><span class="kn">import</span> <span class="nn">pickle</span>
<a href="#__codelineno-3-8" id="__codelineno-3-8" name="__codelineno-3-8"></a><span class="kn">import</span> <span class="nn">time</span>
<a href="#__codelineno-3-9" id="__codelineno-3-9" name="__codelineno-3-9"></a>
<a href="#__codelineno-3-10" id="__codelineno-3-10" name="__codelineno-3-10"></a><span class="k">class</span> <span class="nc">BinaryRBM</span><span class="p">():</span>
<a href="#__codelineno-3-11" id="__codelineno-3-11" name="__codelineno-3-11"></a>
<a href="#__codelineno-3-12" id="__codelineno-3-12" name="__codelineno-3-12"></a>    <span class="c1"># RBM Initialization</span>
<a href="#__codelineno-3-13" id="__codelineno-3-13" name="__codelineno-3-13"></a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_v</span><span class="p">,</span> <span class="n">num_h</span><span class="p">,</span> <span class="n">num_l</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="s2">"CPU"</span><span class="p">):</span>
<a href="#__codelineno-3-14" id="__codelineno-3-14" name="__codelineno-3-14"></a>
<a href="#__codelineno-3-15" id="__codelineno-3-15" name="__codelineno-3-15"></a>        <span class="sd">"""</span>
<a href="#__codelineno-3-16" id="__codelineno-3-16" name="__codelineno-3-16"></a><span class="sd">        Args:</span>
<a href="#__codelineno-3-17" id="__codelineno-3-17" name="__codelineno-3-17"></a><span class="sd">            num_v (int): the number of nodes in the visible layer</span>
<a href="#__codelineno-3-18" id="__codelineno-3-18" name="__codelineno-3-18"></a><span class="sd">            num_h (int): the number of nodes in the hidden layer </span>
<a href="#__codelineno-3-19" id="__codelineno-3-19" name="__codelineno-3-19"></a><span class="sd">            device (str): CPU or GPU mode</span>
<a href="#__codelineno-3-20" id="__codelineno-3-20" name="__codelineno-3-20"></a><span class="sd">        """</span>
<a href="#__codelineno-3-21" id="__codelineno-3-21" name="__codelineno-3-21"></a>
<a href="#__codelineno-3-22" id="__codelineno-3-22" name="__codelineno-3-22"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_v</span> <span class="o">=</span> <span class="n">num_v</span> <span class="c1"># the number of visible nodes</span>
<a href="#__codelineno-3-23" id="__codelineno-3-23" name="__codelineno-3-23"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_h</span> <span class="o">=</span> <span class="n">num_h</span> <span class="c1"># the number of hidden nodes</span>
<a href="#__codelineno-3-24" id="__codelineno-3-24" name="__codelineno-3-24"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">num_l</span> <span class="o">=</span> <span class="n">num_l</span> <span class="c1"># the number of label nodes (which are part of the visible layer)</span>
<a href="#__codelineno-3-25" id="__codelineno-3-25" name="__codelineno-3-25"></a>
<a href="#__codelineno-3-26" id="__codelineno-3-26" name="__codelineno-3-26"></a>        <span class="k">if</span> <span class="n">device</span> <span class="o">==</span> <span class="s2">"GPU"</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
<a href="#__codelineno-3-27" id="__codelineno-3-27" name="__codelineno-3-27"></a>            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">"GPU is not supported"</span><span class="p">)</span>
<a href="#__codelineno-3-28" id="__codelineno-3-28" name="__codelineno-3-28"></a>        <span class="k">elif</span> <span class="n">device</span> <span class="o">==</span> <span class="s2">"GPU"</span> <span class="ow">and</span> <span class="n">torch</span><span class="o">.</span><span class="n">cuda</span><span class="o">.</span><span class="n">is_available</span><span class="p">():</span>
<a href="#__codelineno-3-29" id="__codelineno-3-29" name="__codelineno-3-29"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cuda"</span><span class="p">)</span>
<a href="#__codelineno-3-30" id="__codelineno-3-30" name="__codelineno-3-30"></a>        <span class="k">else</span><span class="p">:</span>
<a href="#__codelineno-3-31" id="__codelineno-3-31" name="__codelineno-3-31"></a>            <span class="bp">self</span><span class="o">.</span><span class="n">device</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">device</span><span class="p">(</span><span class="s2">"cpu"</span><span class="p">)</span>
<a href="#__codelineno-3-32" id="__codelineno-3-32" name="__codelineno-3-32"></a>
<a href="#__codelineno-3-33" id="__codelineno-3-33" name="__codelineno-3-33"></a>        <span class="c1"># normalization to ensure stability ? </span>
<a href="#__codelineno-3-34" id="__codelineno-3-34" name="__codelineno-3-34"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">w_v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_h</span><span class="p">,</span> <span class="n">num_v</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_v</span><span class="p">)</span>
<a href="#__codelineno-3-35" id="__codelineno-3-35" name="__codelineno-3-35"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">w_l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">randn</span><span class="p">(</span><span class="n">num_h</span><span class="p">,</span> <span class="n">num_l</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">num_l</span><span class="p">)</span>
<a href="#__codelineno-3-36" id="__codelineno-3-36" name="__codelineno-3-36"></a>
<a href="#__codelineno-3-37" id="__codelineno-3-37" name="__codelineno-3-37"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_v</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># bias (column) vector for the visible layer</span>
<a href="#__codelineno-3-38" id="__codelineno-3-38" name="__codelineno-3-38"></a>        <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_h</span><span class="p">,</span> <span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">torch</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># bias (column) vector for the hidden layer</span>
<a href="#__codelineno-3-39" id="__codelineno-3-39" name="__codelineno-3-39"></a>
<a href="#__codelineno-3-40" id="__codelineno-3-40" name="__codelineno-3-40"></a>    <span class="k">def</span> <span class="nf">idx2onehot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">idx</span><span class="p">,</span> <span class="n">n</span><span class="p">):</span>
<a href="#__codelineno-3-41" id="__codelineno-3-41" name="__codelineno-3-41"></a>
<a href="#__codelineno-3-42" id="__codelineno-3-42" name="__codelineno-3-42"></a>        <span class="k">assert</span> <span class="n">torch</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">n</span> <span class="ow">and</span> <span class="n">idx</span><span class="o">.</span><span class="n">dim</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span>
<a href="#__codelineno-3-43" id="__codelineno-3-43" name="__codelineno-3-43"></a>        <span class="n">idx2dim</span> <span class="o">=</span> <span class="n">idx</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># change from 1-dim tensor to 2-dim tensor</span>
<a href="#__codelineno-3-44" id="__codelineno-3-44" name="__codelineno-3-44"></a>        <span class="n">onehot</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">idx2dim</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span><span class="n">n</span><span class="p">)</span><span class="o">.</span><span class="n">scatter_</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">idx2dim</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-3-45" id="__codelineno-3-45" name="__codelineno-3-45"></a>
<a href="#__codelineno-3-46" id="__codelineno-3-46" name="__codelineno-3-46"></a>        <span class="k">return</span> <span class="n">onehot</span>
<a href="#__codelineno-3-47" id="__codelineno-3-47" name="__codelineno-3-47"></a>
<a href="#__codelineno-3-48" id="__codelineno-3-48" name="__codelineno-3-48"></a>
<a href="#__codelineno-3-49" id="__codelineno-3-49" name="__codelineno-3-49"></a>
<a href="#__codelineno-3-50" id="__codelineno-3-50" name="__codelineno-3-50"></a>    <span class="c1"># Calculation of the free energy F(v)</span>
<a href="#__codelineno-3-51" id="__codelineno-3-51" name="__codelineno-3-51"></a>    <span class="k">def</span> <span class="nf">free_energy_func</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>
<a href="#__codelineno-3-52" id="__codelineno-3-52" name="__codelineno-3-52"></a>        <span class="sd">"""</span>
<a href="#__codelineno-3-53" id="__codelineno-3-53" name="__codelineno-3-53"></a><span class="sd">        Args:</span>
<a href="#__codelineno-3-54" id="__codelineno-3-54" name="__codelineno-3-54"></a><span class="sd">        v (torch.Tensor): the visible states</span>
<a href="#__codelineno-3-55" id="__codelineno-3-55" name="__codelineno-3-55"></a>
<a href="#__codelineno-3-56" id="__codelineno-3-56" name="__codelineno-3-56"></a><span class="sd">        Returns:</span>
<a href="#__codelineno-3-57" id="__codelineno-3-57" name="__codelineno-3-57"></a><span class="sd">        free_energy (torch.Tensor): the free energy F(v) (c.f. Eq (12))</span>
<a href="#__codelineno-3-58" id="__codelineno-3-58" name="__codelineno-3-58"></a>
<a href="#__codelineno-3-59" id="__codelineno-3-59" name="__codelineno-3-59"></a><span class="sd">        """</span>
<a href="#__codelineno-3-60" id="__codelineno-3-60" name="__codelineno-3-60"></a>        <span class="c1"># c.f. Eq.(12)</span>
<a href="#__codelineno-3-61" id="__codelineno-3-61" name="__codelineno-3-61"></a>        <span class="c1"># .sum(0) represents the summation of different rows</span>
<a href="#__codelineno-3-62" id="__codelineno-3-62" name="__codelineno-3-62"></a>        <span class="c1"># F.softplus(x) calculates log(1+exp(x))</span>
<a href="#__codelineno-3-63" id="__codelineno-3-63" name="__codelineno-3-63"></a>
<a href="#__codelineno-3-64" id="__codelineno-3-64" name="__codelineno-3-64"></a>        <span class="k">return</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span><span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span> <span class="o">-</span> <span class="n">F</span><span class="o">.</span><span class="n">softplus</span><span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">addmm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">w_v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">w_l</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">),</span><span class="n">l</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)),</span><span class="mi">0</span><span class="p">)))</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<a href="#__codelineno-3-65" id="__codelineno-3-65" name="__codelineno-3-65"></a>
<a href="#__codelineno-3-66" id="__codelineno-3-66" name="__codelineno-3-66"></a>    <span class="k">def</span> <span class="nf">sample_h_given_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">label</span><span class="p">):</span>
<a href="#__codelineno-3-67" id="__codelineno-3-67" name="__codelineno-3-67"></a>        <span class="sd">"""</span>
<a href="#__codelineno-3-68" id="__codelineno-3-68" name="__codelineno-3-68"></a><span class="sd">          Args:</span>
<a href="#__codelineno-3-69" id="__codelineno-3-69" name="__codelineno-3-69"></a><span class="sd">        v (torch.Tensor): the visible states</span>
<a href="#__codelineno-3-70" id="__codelineno-3-70" name="__codelineno-3-70"></a>
<a href="#__codelineno-3-71" id="__codelineno-3-71" name="__codelineno-3-71"></a>
<a href="#__codelineno-3-72" id="__codelineno-3-72" name="__codelineno-3-72"></a><span class="sd">        Returns:</span>
<a href="#__codelineno-3-73" id="__codelineno-3-73" name="__codelineno-3-73"></a><span class="sd">        sampled_h (torch.Tensor): the sample h according to Eq.(17). </span>
<a href="#__codelineno-3-74" id="__codelineno-3-74" name="__codelineno-3-74"></a><span class="sd">                                  It is a column vector that contains 0 or 1. </span>
<a href="#__codelineno-3-75" id="__codelineno-3-75" name="__codelineno-3-75"></a>
<a href="#__codelineno-3-76" id="__codelineno-3-76" name="__codelineno-3-76"></a><span class="sd">        """</span>
<a href="#__codelineno-3-77" id="__codelineno-3-77" name="__codelineno-3-77"></a>
<a href="#__codelineno-3-78" id="__codelineno-3-78" name="__codelineno-3-78"></a>        <span class="k">return</span> <span class="p">(</span><span class="n">torch</span><span class="o">.</span><span class="n">addmm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">w_v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">w_l</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">v</span><span class="p">,</span><span class="n">label</span><span class="p">),</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">()</span><span class="o">&gt;</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_h</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">))</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="c1"># c.f. Eq (17)</span>
<a href="#__codelineno-3-79" id="__codelineno-3-79" name="__codelineno-3-79"></a>
<a href="#__codelineno-3-80" id="__codelineno-3-80" name="__codelineno-3-80"></a>    <span class="k">def</span> <span class="nf">sample_v_given_h</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
<a href="#__codelineno-3-81" id="__codelineno-3-81" name="__codelineno-3-81"></a>        <span class="sd">"""</span>
<a href="#__codelineno-3-82" id="__codelineno-3-82" name="__codelineno-3-82"></a><span class="sd">        Args:</span>
<a href="#__codelineno-3-83" id="__codelineno-3-83" name="__codelineno-3-83"></a><span class="sd">        h (torch.Tensor): the hidden states</span>
<a href="#__codelineno-3-84" id="__codelineno-3-84" name="__codelineno-3-84"></a>
<a href="#__codelineno-3-85" id="__codelineno-3-85" name="__codelineno-3-85"></a><span class="sd">        Returns:</span>
<a href="#__codelineno-3-86" id="__codelineno-3-86" name="__codelineno-3-86"></a><span class="sd">        sampled_v (torch.Tensor): the sample v according to Eq.(18). </span>
<a href="#__codelineno-3-87" id="__codelineno-3-87" name="__codelineno-3-87"></a><span class="sd">                                  It is a column vector that contains 0 or 1. </span>
<a href="#__codelineno-3-88" id="__codelineno-3-88" name="__codelineno-3-88"></a>
<a href="#__codelineno-3-89" id="__codelineno-3-89" name="__codelineno-3-89"></a><span class="sd">        """</span>
<a href="#__codelineno-3-90" id="__codelineno-3-90" name="__codelineno-3-90"></a>        <span class="k">return</span> <span class="p">(</span> <span class="n">torch</span><span class="o">.</span><span class="n">addmm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_v</span><span class="o">.</span><span class="n">t</span><span class="p">(),</span> <span class="n">h</span><span class="p">)</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">()</span><span class="o">&gt;</span><span class="n">torch</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_v</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="p">)</span><span class="o">.</span><span class="n">float</span><span class="p">()</span> <span class="c1"># c.f. Eq (18)</span>
<a href="#__codelineno-3-91" id="__codelineno-3-91" name="__codelineno-3-91"></a>
<a href="#__codelineno-3-92" id="__codelineno-3-92" name="__codelineno-3-92"></a>
<a href="#__codelineno-3-93" id="__codelineno-3-93" name="__codelineno-3-93"></a>    <span class="k">def</span> <span class="nf">block_gibbs_sampling</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_v</span><span class="p">,</span> <span class="n">label</span><span class="p">,</span> <span class="n">num_iter</span><span class="p">):</span>
<a href="#__codelineno-3-94" id="__codelineno-3-94" name="__codelineno-3-94"></a>        <span class="sd">"""</span>
<a href="#__codelineno-3-95" id="__codelineno-3-95" name="__codelineno-3-95"></a><span class="sd">        Args:</span>
<a href="#__codelineno-3-96" id="__codelineno-3-96" name="__codelineno-3-96"></a><span class="sd">        initial_v (torch.Tensor): the initial visible states to start the block gibbs sampling</span>
<a href="#__codelineno-3-97" id="__codelineno-3-97" name="__codelineno-3-97"></a><span class="sd">        num_iter(int): the number of iterations for the gibbs sampling</span>
<a href="#__codelineno-3-98" id="__codelineno-3-98" name="__codelineno-3-98"></a>
<a href="#__codelineno-3-99" id="__codelineno-3-99" name="__codelineno-3-99"></a><span class="sd">        Returns:</span>
<a href="#__codelineno-3-100" id="__codelineno-3-100" name="__codelineno-3-100"></a><span class="sd">        gibbs_v (torch.Tensor): the sampled visible states</span>
<a href="#__codelineno-3-101" id="__codelineno-3-101" name="__codelineno-3-101"></a><span class="sd">        """</span>
<a href="#__codelineno-3-102" id="__codelineno-3-102" name="__codelineno-3-102"></a>        <span class="n">v</span> <span class="o">=</span> <span class="n">initial_v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a href="#__codelineno-3-103" id="__codelineno-3-103" name="__codelineno-3-103"></a>        <span class="n">label</span> <span class="o">=</span> <span class="n">label</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<a href="#__codelineno-3-104" id="__codelineno-3-104" name="__codelineno-3-104"></a>        <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_iter</span><span class="p">):</span>
<a href="#__codelineno-3-105" id="__codelineno-3-105" name="__codelineno-3-105"></a>
<a href="#__codelineno-3-106" id="__codelineno-3-106" name="__codelineno-3-106"></a>            <span class="n">h</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_h_given_v</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">label</span><span class="p">)</span>
<a href="#__codelineno-3-107" id="__codelineno-3-107" name="__codelineno-3-107"></a>            <span class="n">v</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_v_given_h</span><span class="p">(</span><span class="n">h</span><span class="p">)</span>
<a href="#__codelineno-3-108" id="__codelineno-3-108" name="__codelineno-3-108"></a>
<a href="#__codelineno-3-109" id="__codelineno-3-109" name="__codelineno-3-109"></a>        <span class="k">return</span> <span class="n">v</span>
<a href="#__codelineno-3-110" id="__codelineno-3-110" name="__codelineno-3-110"></a>
<a href="#__codelineno-3-111" id="__codelineno-3-111" name="__codelineno-3-111"></a>    <span class="k">def</span> <span class="nf">free_energy_gradient</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<a href="#__codelineno-3-112" id="__codelineno-3-112" name="__codelineno-3-112"></a>        <span class="sd">"""</span>
<a href="#__codelineno-3-113" id="__codelineno-3-113" name="__codelineno-3-113"></a><span class="sd">        Args:</span>
<a href="#__codelineno-3-114" id="__codelineno-3-114" name="__codelineno-3-114"></a><span class="sd">        v (torch.Tensor): the visible states</span>
<a href="#__codelineno-3-115" id="__codelineno-3-115" name="__codelineno-3-115"></a>
<a href="#__codelineno-3-116" id="__codelineno-3-116" name="__codelineno-3-116"></a><span class="sd">        Returns:</span>
<a href="#__codelineno-3-117" id="__codelineno-3-117" name="__codelineno-3-117"></a><span class="sd">        grad_w (torch.Tensor): the average gradient of the free energy with respect to w across all samples</span>
<a href="#__codelineno-3-118" id="__codelineno-3-118" name="__codelineno-3-118"></a><span class="sd">        grad_b (torch.Tensor): the average gradient of the free energy with respect to b across all samples</span>
<a href="#__codelineno-3-119" id="__codelineno-3-119" name="__codelineno-3-119"></a><span class="sd">        grad_c (torch.Tensor): the average gradient of the free energy with respect to c across all samples</span>
<a href="#__codelineno-3-120" id="__codelineno-3-120" name="__codelineno-3-120"></a>
<a href="#__codelineno-3-121" id="__codelineno-3-121" name="__codelineno-3-121"></a><span class="sd">        """</span>
<a href="#__codelineno-3-122" id="__codelineno-3-122" name="__codelineno-3-122"></a>        <span class="n">temp</span> <span class="o">=</span> <span class="o">-</span><span class="n">torch</span><span class="o">.</span><span class="n">addmm</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">c</span><span class="p">,</span> <span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">w_v</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">w_l</span><span class="p">),</span><span class="mi">1</span><span class="p">),</span><span class="n">torch</span><span class="o">.</span><span class="n">cat</span><span class="p">((</span><span class="n">v</span><span class="p">,</span><span class="n">label</span><span class="p">),</span><span class="mi">0</span><span class="p">))</span><span class="o">.</span><span class="n">sigmoid_</span><span class="p">()</span>
<a href="#__codelineno-3-123" id="__codelineno-3-123" name="__codelineno-3-123"></a>
<a href="#__codelineno-3-124" id="__codelineno-3-124" name="__codelineno-3-124"></a>        <span class="n">grad_c</span> <span class="o">=</span>  <span class="n">temp</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-3-125" id="__codelineno-3-125" name="__codelineno-3-125"></a>        <span class="n">grad_b</span> <span class="o">=</span> <span class="o">-</span> <span class="n">v</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">unsqueeze</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-3-126" id="__codelineno-3-126" name="__codelineno-3-126"></a>        <span class="n">grad_w_v</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">v</span><span class="o">.</span><span class="n">t</span><span class="p">())</span><span class="o">/</span><span class="n">v</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-3-127" id="__codelineno-3-127" name="__codelineno-3-127"></a>        <span class="n">grad_w_l</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">matmul</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span><span class="n">label</span><span class="o">.</span><span class="n">t</span><span class="p">())</span><span class="o">/</span><span class="n">label</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-3-128" id="__codelineno-3-128" name="__codelineno-3-128"></a>
<a href="#__codelineno-3-129" id="__codelineno-3-129" name="__codelineno-3-129"></a>        <span class="c1"># v.size(1)  == label.size(1) == batch_size</span>
<a href="#__codelineno-3-130" id="__codelineno-3-130" name="__codelineno-3-130"></a>
<a href="#__codelineno-3-131" id="__codelineno-3-131" name="__codelineno-3-131"></a>        <span class="k">return</span> <span class="n">grad_w_v</span><span class="p">,</span> <span class="n">grad_w_l</span><span class="p">,</span> <span class="n">grad_b</span><span class="p">,</span> <span class="n">grad_c</span>
<a href="#__codelineno-3-132" id="__codelineno-3-132" name="__codelineno-3-132"></a>
<a href="#__codelineno-3-133" id="__codelineno-3-133" name="__codelineno-3-133"></a>    <span class="k">def</span> <span class="nf">mini_batch_gradient_func</span> <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">cd_k</span><span class="p">,</span><span class="n">labels</span><span class="p">):</span>
<a href="#__codelineno-3-134" id="__codelineno-3-134" name="__codelineno-3-134"></a>
<a href="#__codelineno-3-135" id="__codelineno-3-135" name="__codelineno-3-135"></a>        <span class="sd">"""</span>
<a href="#__codelineno-3-136" id="__codelineno-3-136" name="__codelineno-3-136"></a><span class="sd">        Args:</span>
<a href="#__codelineno-3-137" id="__codelineno-3-137" name="__codelineno-3-137"></a><span class="sd">        v (torch.Tensor): the visible states</span>
<a href="#__codelineno-3-138" id="__codelineno-3-138" name="__codelineno-3-138"></a><span class="sd">        cd_k (int): cd_k mode that is chosen</span>
<a href="#__codelineno-3-139" id="__codelineno-3-139" name="__codelineno-3-139"></a>
<a href="#__codelineno-3-140" id="__codelineno-3-140" name="__codelineno-3-140"></a><span class="sd">        Returns:</span>
<a href="#__codelineno-3-141" id="__codelineno-3-141" name="__codelineno-3-141"></a><span class="sd">        grad_mini_batch (Torch) the average gradient across all samples in the mini-batch</span>
<a href="#__codelineno-3-142" id="__codelineno-3-142" name="__codelineno-3-142"></a><span class="sd">        """</span>
<a href="#__codelineno-3-143" id="__codelineno-3-143" name="__codelineno-3-143"></a>        <span class="n">v</span> <span class="o">=</span> <span class="n">v</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">device</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">device</span><span class="p">)</span> <span class="c1"># move to GPU if necessary </span>
<a href="#__codelineno-3-144" id="__codelineno-3-144" name="__codelineno-3-144"></a>
<a href="#__codelineno-3-145" id="__codelineno-3-145" name="__codelineno-3-145"></a>        <span class="n">v_k</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">block_gibbs_sampling</span><span class="p">(</span><span class="n">initial_v</span> <span class="o">=</span> <span class="n">v</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="n">labels</span><span class="p">,</span> <span class="n">num_iter</span> <span class="o">=</span> <span class="n">cd_k</span><span class="p">)</span>
<a href="#__codelineno-3-146" id="__codelineno-3-146" name="__codelineno-3-146"></a>
<a href="#__codelineno-3-147" id="__codelineno-3-147" name="__codelineno-3-147"></a>        <span class="p">[</span><span class="n">grad_w_v_pos</span><span class="p">,</span><span class="n">grad_w_l_pos</span><span class="p">,</span> <span class="n">grad_b_pos</span><span class="p">,</span> <span class="n">grad_c_pos</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_energy_gradient</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="n">labels</span><span class="p">)</span>
<a href="#__codelineno-3-148" id="__codelineno-3-148" name="__codelineno-3-148"></a>        <span class="p">[</span><span class="n">grad_w_v_neg</span><span class="p">,</span><span class="n">grad_w_l_neg</span><span class="p">,</span> <span class="n">grad_b_neg</span><span class="p">,</span> <span class="n">grad_c_neg</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">free_energy_gradient</span><span class="p">(</span><span class="n">v_k</span><span class="p">,</span><span class="n">labels</span><span class="p">)</span>
<a href="#__codelineno-3-149" id="__codelineno-3-149" name="__codelineno-3-149"></a>
<a href="#__codelineno-3-150" id="__codelineno-3-150" name="__codelineno-3-150"></a>        <span class="k">return</span> <span class="n">grad_w_v_pos</span> <span class="o">-</span> <span class="n">grad_w_v_neg</span><span class="p">,</span> <span class="n">grad_w_l_pos</span> <span class="o">-</span> <span class="n">grad_w_l_neg</span><span class="p">,</span> <span class="n">grad_b_pos</span> <span class="o">-</span> <span class="n">grad_b_neg</span><span class="p">,</span> <span class="n">grad_c_pos</span> <span class="o">-</span> <span class="n">grad_c_neg</span> <span class="c1"># c.f. Eq.(13)</span>
<a href="#__codelineno-3-151" id="__codelineno-3-151" name="__codelineno-3-151"></a>
<a href="#__codelineno-3-152" id="__codelineno-3-152" name="__codelineno-3-152"></a>    <span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">dataloader</span><span class="p">,</span> <span class="n">cd_k</span><span class="p">,</span> <span class="n">max_epochs</span> <span class="o">=</span> <span class="mi">5</span><span class="p">,</span> <span class="n">lr</span> <span class="o">=</span> <span class="mf">0.01</span><span class="p">):</span>
<a href="#__codelineno-3-153" id="__codelineno-3-153" name="__codelineno-3-153"></a>        <span class="sd">"""</span>
<a href="#__codelineno-3-154" id="__codelineno-3-154" name="__codelineno-3-154"></a><span class="sd">        Args:</span>
<a href="#__codelineno-3-155" id="__codelineno-3-155" name="__codelineno-3-155"></a><span class="sd">        dataloader: dataloader of the training data </span>
<a href="#__codelineno-3-156" id="__codelineno-3-156" name="__codelineno-3-156"></a><span class="sd">        cd_k: the contrastive divergence mode</span>
<a href="#__codelineno-3-157" id="__codelineno-3-157" name="__codelineno-3-157"></a><span class="sd">        max_epochs: number of epochs</span>
<a href="#__codelineno-3-158" id="__codelineno-3-158" name="__codelineno-3-158"></a><span class="sd">        lr: the learning rate</span>
<a href="#__codelineno-3-159" id="__codelineno-3-159" name="__codelineno-3-159"></a>
<a href="#__codelineno-3-160" id="__codelineno-3-160" name="__codelineno-3-160"></a><span class="sd">        Returns:</span>
<a href="#__codelineno-3-161" id="__codelineno-3-161" name="__codelineno-3-161"></a><span class="sd">        w, b, c: the parameters of the RBM</span>
<a href="#__codelineno-3-162" id="__codelineno-3-162" name="__codelineno-3-162"></a><span class="sd">        """</span>
<a href="#__codelineno-3-163" id="__codelineno-3-163" name="__codelineno-3-163"></a>        <span class="k">for</span> <span class="nb">iter</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">max_epochs</span><span class="p">):</span>
<a href="#__codelineno-3-164" id="__codelineno-3-164" name="__codelineno-3-164"></a>
<a href="#__codelineno-3-165" id="__codelineno-3-165" name="__codelineno-3-165"></a>            <span class="nb">print</span><span class="p">(</span><span class="s1">'Epoch </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">iter</span><span class="p">))</span>
<a href="#__codelineno-3-166" id="__codelineno-3-166" name="__codelineno-3-166"></a>
<a href="#__codelineno-3-167" id="__codelineno-3-167" name="__codelineno-3-167"></a>            <span class="k">for</span> <span class="n">mini_batch_samples</span> <span class="ow">in</span> <span class="n">dataloader</span><span class="p">:</span>
<a href="#__codelineno-3-168" id="__codelineno-3-168" name="__codelineno-3-168"></a>                <span class="n">mini_batch_samples_</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">flatten</span><span class="p">(</span><span class="n">mini_batch_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span><span class="n">start_dim</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">t</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">()</span>
<a href="#__codelineno-3-169" id="__codelineno-3-169" name="__codelineno-3-169"></a>
<a href="#__codelineno-3-170" id="__codelineno-3-170" name="__codelineno-3-170"></a>                <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">idx2onehot</span><span class="p">(</span><span class="n">mini_batch_samples</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span><span class="mi">10</span><span class="p">)</span><span class="o">.</span><span class="n">t</span><span class="p">()</span>
<a href="#__codelineno-3-171" id="__codelineno-3-171" name="__codelineno-3-171"></a>
<a href="#__codelineno-3-172" id="__codelineno-3-172" name="__codelineno-3-172"></a>
<a href="#__codelineno-3-173" id="__codelineno-3-173" name="__codelineno-3-173"></a>                <span class="c1"># we use mini_batch_samples[0] to extract the data since mini_batch_samples[1] is the label. </span>
<a href="#__codelineno-3-174" id="__codelineno-3-174" name="__codelineno-3-174"></a>                <span class="c1"># each column in  mini_batch_samples_ is corresponding to one data sample. </span>
<a href="#__codelineno-3-175" id="__codelineno-3-175" name="__codelineno-3-175"></a>
<a href="#__codelineno-3-176" id="__codelineno-3-176" name="__codelineno-3-176"></a>                <span class="n">grad_w_v</span><span class="p">,</span> <span class="n">grad_w_l</span><span class="p">,</span> <span class="n">grad_b</span><span class="p">,</span> <span class="n">grad_c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mini_batch_gradient_func</span><span class="p">(</span><span class="n">mini_batch_samples_</span><span class="p">,</span> <span class="n">cd_k</span><span class="p">,</span> <span class="n">labels</span><span class="p">)</span>
<a href="#__codelineno-3-177" id="__codelineno-3-177" name="__codelineno-3-177"></a>
<a href="#__codelineno-3-178" id="__codelineno-3-178" name="__codelineno-3-178"></a>
<a href="#__codelineno-3-179" id="__codelineno-3-179" name="__codelineno-3-179"></a>                <span class="c1"># update w, b, c</span>
<a href="#__codelineno-3-180" id="__codelineno-3-180" name="__codelineno-3-180"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">w_v</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">grad_w_v</span>
<a href="#__codelineno-3-181" id="__codelineno-3-181" name="__codelineno-3-181"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">w_l</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">grad_w_l</span>
<a href="#__codelineno-3-182" id="__codelineno-3-182" name="__codelineno-3-182"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">b</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">grad_b</span>
<a href="#__codelineno-3-183" id="__codelineno-3-183" name="__codelineno-3-183"></a>                <span class="bp">self</span><span class="o">.</span><span class="n">c</span> <span class="o">-=</span> <span class="n">lr</span> <span class="o">*</span> <span class="n">grad_c</span>
<a href="#__codelineno-3-184" id="__codelineno-3-184" name="__codelineno-3-184"></a>            <span class="c1"># break</span>
<a href="#__codelineno-3-185" id="__codelineno-3-185" name="__codelineno-3-185"></a>
<a href="#__codelineno-3-186" id="__codelineno-3-186" name="__codelineno-3-186"></a>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">w_l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">b</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">c</span>
<a href="#__codelineno-3-187" id="__codelineno-3-187" name="__codelineno-3-187"></a>
<a href="#__codelineno-3-188" id="__codelineno-3-188" name="__codelineno-3-188"></a>
<a href="#__codelineno-3-189" id="__codelineno-3-189" name="__codelineno-3-189"></a>
<a href="#__codelineno-3-190" id="__codelineno-3-190" name="__codelineno-3-190"></a>
<a href="#__codelineno-3-191" id="__codelineno-3-191" name="__codelineno-3-191"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">"__main__"</span><span class="p">:</span>
<a href="#__codelineno-3-192" id="__codelineno-3-192" name="__codelineno-3-192"></a>
<a href="#__codelineno-3-193" id="__codelineno-3-193" name="__codelineno-3-193"></a>    <span class="n">model</span> <span class="o">=</span> <span class="n">BinaryRBM</span><span class="p">(</span><span class="mi">784</span><span class="p">,</span><span class="mi">128</span><span class="p">,</span><span class="mi">10</span><span class="p">,</span><span class="n">device</span><span class="o">=</span><span class="s2">"CPU"</span><span class="p">)</span>
<a href="#__codelineno-3-194" id="__codelineno-3-194" name="__codelineno-3-194"></a>
<a href="#__codelineno-3-195" id="__codelineno-3-195" name="__codelineno-3-195"></a>    <span class="c1"># Load Data</span>
<a href="#__codelineno-3-196" id="__codelineno-3-196" name="__codelineno-3-196"></a>    <span class="n">train_dataset</span> <span class="o">=</span> <span class="n">torchvision</span><span class="o">.</span><span class="n">datasets</span><span class="o">.</span><span class="n">MNIST</span><span class="p">(</span><span class="s2">"~"</span><span class="p">,</span> <span class="n">train</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="o">.</span><span class="n">ToTensor</span><span class="p">(),</span> <span class="n">download</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<a href="#__codelineno-3-197" id="__codelineno-3-197" name="__codelineno-3-197"></a>    <span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">DataLoader</span><span class="p">(</span><span class="n">train_dataset</span><span class="p">,</span> <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">32</span><span class="p">,</span><span class="n">shuffle</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<a href="#__codelineno-3-198" id="__codelineno-3-198" name="__codelineno-3-198"></a>
<a href="#__codelineno-3-199" id="__codelineno-3-199" name="__codelineno-3-199"></a>    <span class="c1"># Train</span>
<a href="#__codelineno-3-200" id="__codelineno-3-200" name="__codelineno-3-200"></a>    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
<a href="#__codelineno-3-201" id="__codelineno-3-201" name="__codelineno-3-201"></a>    <span class="n">w</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">c</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">train</span><span class="p">(</span><span class="n">train_loader</span><span class="p">,</span> <span class="n">cd_k</span> <span class="o">=</span> <span class="mi">5</span><span class="p">)</span>
<a href="#__codelineno-3-202" id="__codelineno-3-202" name="__codelineno-3-202"></a>    <span class="n">elapsed_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">start_time</span>
<a href="#__codelineno-3-203" id="__codelineno-3-203" name="__codelineno-3-203"></a>
<a href="#__codelineno-3-204" id="__codelineno-3-204" name="__codelineno-3-204"></a>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">'objs.pkl'</span><span class="p">,</span> <span class="s1">'wb'</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>  <span class="c1"># Python 3: open(..., 'wb')</span>
<a href="#__codelineno-3-205" id="__codelineno-3-205" name="__codelineno-3-205"></a>        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">([</span><span class="n">w</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span> <span class="n">b</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span><span class="n">c</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()],</span> <span class="n">f</span><span class="p">)</span>
<a href="#__codelineno-3-206" id="__codelineno-3-206" name="__codelineno-3-206"></a>
<a href="#__codelineno-3-207" id="__codelineno-3-207" name="__codelineno-3-207"></a>    <span class="nb">print</span><span class="p">(</span><span class="s2">"Training Ended. Elapsed Time is </span><span class="si">{0:.2f}</span><span class="s2">s"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">elapsed_time</span><span class="p">))</span>
<a href="#__codelineno-3-208" id="__codelineno-3-208" name="__codelineno-3-208"></a>
<a href="#__codelineno-3-209" id="__codelineno-3-209" name="__codelineno-3-209"></a>
<a href="#__codelineno-3-210" id="__codelineno-3-210" name="__codelineno-3-210"></a>
<a href="#__codelineno-3-211" id="__codelineno-3-211" name="__codelineno-3-211"></a>    <span class="c1"># Test </span>
<a href="#__codelineno-3-212" id="__codelineno-3-212" name="__codelineno-3-212"></a>
<a href="#__codelineno-3-213" id="__codelineno-3-213" name="__codelineno-3-213"></a>    <span class="c1"># retrieve the next image data for testing </span>
<a href="#__codelineno-3-214" id="__codelineno-3-214" name="__codelineno-3-214"></a>    <span class="n">i</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">train_loader</span><span class="p">)</span><span class="o">.</span><span class="n">next</span><span class="p">()[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
<a href="#__codelineno-3-215" id="__codelineno-3-215" name="__codelineno-3-215"></a>
<a href="#__codelineno-3-216" id="__codelineno-3-216" name="__codelineno-3-216"></a>    <span class="c1"># Generate new visible states with a random initial visible states via Gibbs sampling the RBM</span>
<a href="#__codelineno-3-217" id="__codelineno-3-217" name="__codelineno-3-217"></a>    <span class="n">v_gen</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">block_gibbs_sampling</span><span class="p">(</span><span class="n">initial_v</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(),</span><span class="n">num_iter</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span>
<a href="#__codelineno-3-218" id="__codelineno-3-218" name="__codelineno-3-218"></a>
<a href="#__codelineno-3-219" id="__codelineno-3-219" name="__codelineno-3-219"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<a href="#__codelineno-3-220" id="__codelineno-3-220" name="__codelineno-3-220"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">121</span><span class="p">)</span>
<a href="#__codelineno-3-221" id="__codelineno-3-221" name="__codelineno-3-221"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">round</span><span class="p">(),</span><span class="n">cmap</span> <span class="o">=</span> <span class="s2">"gray"</span><span class="p">)</span>
<a href="#__codelineno-3-222" id="__codelineno-3-222" name="__codelineno-3-222"></a>
<a href="#__codelineno-3-223" id="__codelineno-3-223" name="__codelineno-3-223"></a>    <span class="c1"># Display the images</span>
<a href="#__codelineno-3-224" id="__codelineno-3-224" name="__codelineno-3-224"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">122</span><span class="p">)</span>
<a href="#__codelineno-3-225" id="__codelineno-3-225" name="__codelineno-3-225"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">v_gen</span><span class="o">.</span><span class="n">view</span><span class="p">(</span><span class="mi">28</span><span class="p">,</span><span class="mi">28</span><span class="p">)</span><span class="o">.</span><span class="n">numpy</span><span class="p">(),</span><span class="n">cmap</span> <span class="o">=</span> <span class="s2">"gray"</span><span class="p">)</span>
<a href="#__codelineno-3-226" id="__codelineno-3-226" name="__codelineno-3-226"></a>    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</code></pre></div>
<h2 id="__comments"><span class="enumerate-headings-plugin enumerate-heading-plugin">1.4</span> Comments</h2>
<!-- Insert generated snippet here -->
<script async="" crossorigin="anonymous" data-category="General" data-category-id="DIC_kwDOINKUzM4CSBXc" data-emit-metadata="0" data-input-position="bottom" data-lang="en" data-mapping="pathname" data-reactions-enabled="1" data-repo="haoma7/haoma7.github.io" data-repo-id="R_kgDOINKUzA" data-strict="0" data-theme="preferred_color_scheme" src="https://giscus.app/client.js">
</script>
<!-- Synchronize Giscus theme with palette -->
<script>
    var giscus = document.querySelector("script[src*=giscus]")

    /* Set palette on initial load */
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object") {
      var theme = palette.color.scheme === "slate" ? "dark" : "light"
      giscus.setAttribute("data-theme", theme) 
    }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function() {
      var ref = document.querySelector("[data-md-component=palette]")
      ref.addEventListener("change", function() {
        var palette = __md_get("__palette")
        if (palette && typeof palette.color === "object") {
          var theme = palette.color.scheme === "slate" ? "dark" : "light"

          /* Instruct Giscus to change theme */
          var frame = document.querySelector(".giscus-frame")
          frame.contentWindow.postMessage(
            { giscus: { setConfig: { theme } } },
            "https://giscus.app"
          )
        }
      })
    })
  </script>
<style>
      main{
         font-family: "Exo 2", Lora, Roboto, system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      }

   </style>
</article>
</div>
</div>
<a class="md-top md-icon" data-md-component="top" hidden="" href="#">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"></path></svg>
            Back to top
          </a>
</main>
<footer class="md-footer">
<nav aria-label="Footer" class="md-footer__inner md-grid">
<a aria-label="Previous: Test Index.md in section folder" class="md-footer__link md-footer__link--prev" href="../" rel="prev">
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"></path></svg>
</div>
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Previous
              </span>
              Test Index.md in section folder
            </div>
</div>
</a>
<a aria-label="Next: Head First Transformer" class="md-footer__link md-footer__link--next" href="../transformer/" rel="next">
<div class="md-footer__title">
<div class="md-ellipsis">
<span class="md-footer__direction">
                Next
              </span>
              Head First Transformer
            </div>
</div>
<div class="md-footer__button md-icon">
<svg viewbox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4Z"></path></svg>
</div>
</a>
</nav>
<div class="md-footer-meta md-typeset">
<div class="md-footer-meta__inner md-grid">
<div class="md-copyright">
</div>
<div class="md-social">
<a class="md-social__link" href="https://github.com/haoma7" rel="noopener" target="_blank" title="github.com">
<svg viewbox="0 0 496 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6zm-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3zm44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9zM244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8zM97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1zm-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7zm32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1zm-11.4-14.7c-1.6 1-1.6 3.6 0 5.9 1.6 2.3 4.3 3.3 5.6 2.3 1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2z"></path></svg>
</a>
<a class="md-social__link" href="https://scholar.google.com/citations?user=F44gDZ4AAAAJ" rel="noopener" target="_blank" title="scholar.google.com">
<svg viewbox="0 0 512 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M504 256C504 119 393 8 256 8S8 119 8 256c0 123.78 90.69 226.38 209.25 245V327.69h-63V256h63v-54.64c0-62.15 37-96.48 93.67-96.48 27.14 0 55.52 4.84 55.52 4.84v61h-31.28c-30.8 0-40.41 19.12-40.41 38.73V256h68.78l-11 71.69h-57.78V501C413.31 482.38 504 379.78 504 256z"></path></svg>
</a>
<a class="md-social__link" href="https://www.linkedin.com/in/mahao/" rel="noopener" target="_blank" title="www.linkedin.com">
<svg viewbox="0 0 448 512" xmlns="http://www.w3.org/2000/svg"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc.--><path d="M416 32H31.9C14.3 32 0 46.5 0 64.3v383.4C0 465.5 14.3 480 31.9 480H416c17.6 0 32-14.5 32-32.3V64.3c0-17.8-14.4-32.3-32-32.3zM135.4 416H69V202.2h66.5V416zm-33.2-243c-21.3 0-38.5-17.3-38.5-38.5S80.9 96 102.2 96c21.2 0 38.5 17.3 38.5 38.5 0 21.3-17.2 38.5-38.5 38.5zm282.1 243h-66.4V312c0-24.8-.5-56.7-34.5-56.7-34.6 0-39.9 27-39.9 54.9V416h-66.4V202.2h63.7v29.2h.9c8.9-16.8 30.6-34.5 62.9-34.5 67.2 0 79.7 44.3 79.7 101.9V416z"></path></svg>
</a>
</div>
</div>
</div>
</footer>
<!-- <img class='doraemon' src="../../../assets/doraemon.gif"> -->
<div class="doraemon">
<img src="../../../assets/searching.gif"/>
</div>
<style>
      div.doraemon { position: relative; height: 0px; float: right; margin-top: 0px;}
      div.doraemon img { position: absolute; left: 22rem; bottom: 0; height:4rem}
      </style>
</div>
<div class="md-dialog" data-md-component="dialog">
<div class="md-dialog__inner md-typeset"></div>
</div>
<script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.instant", "navigation.tracking", "navigation.tabs", "navigation.tabs.sticky", "navigation.expand", "navigation.indexes", "navigation.top", "header.autohide", "announce.dismiss"], "search": "../../../assets/javascripts/workers/search.5bf1dace.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version.title": "Select version"}}</script>
<script src="../../../assets/javascripts/bundle.078830c0.min.js"></script>
<script src="../../../javascripts/extra.js"></script>
<script src="../../../javascripts/mathjax.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</body>
</html>